<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Quản lý Xe và Đơn hàng</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', 'Arial Unicode MS', 'Arial', 'Tahoma', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }
        .nav-tabs {
            display: flex;
            background: #34495e;
            border-bottom: 1px solid #2c3e50;
        }
        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            color: #ecf0f1;
            border-right: 1px solid #2c3e50;
            transition: background 0.3s;
        }
        .nav-tab:last-child {
            border-right: none;
        }
        .nav-tab.active {
            background: #3498db;
        }
        .nav-tab:hover {
            background: #2980b9;
        }
        .tab-content {
            display: none;
            padding: 20px;
        }
        .tab-content.active {
            display: block;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 14px;
        }
        .form-row {
            display: flex;
            gap: 15px;
        }
        .form-row .form-group {
            flex: 1;
        }
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        .btn:hover {
            background: #2980b9;
        }
        .btn-success {
            background: #27ae60;
        }
        .btn-success:hover {
            background: #229954;
        }
        .btn-danger {
            background: #e74c3c;
        }
        .btn-danger:hover {
            background: #c0392b;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #bdc3c7;
        }
        .table th {
            background: #ecf0f1;
            font-weight: bold;
            color: #2c3e50;
        }
        .table tr:hover {
            background: #f8f9fa;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-pending {
            background: #f39c12;
            color: white;
        }
        .status-in-transit {
            background: #3498db;
            color: white;
        }
        .status-delivered {
            background: #27ae60;
            color: white;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: #000;
        }
        .search-box {
            margin-bottom: 20px;
        }
        .search-box input {
            width: 300px;
            padding: 8px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Quản lý Xe và Đơn hàng</h1>
            <p>Hệ thống quản lý xe vận tải và phân phối đơn hàng</p>
        </div>

        <div class="nav-tabs">
            <div class="nav-tab active" onclick="showTab('vehicles')">Quản lý Xe</div>
            <div class="nav-tab" onclick="showTab('assignments')">Phân phối Đơn hàng</div>
            <div class="nav-tab" onclick="showTab('status')">Trạng thái Xe</div>
            <div class="nav-tab" onclick="showTab('unassigned')">Đơn chưa xếp</div>
        </div>

        <!-- Tab 1: Quản lý Xe -->
        <div id="vehicles" class="tab-content active">
            <div class="form-group">
                <button class="btn btn-success" onclick="showVehicleModal()">Thêm Xe mới</button>
            </div>
            
            <div class="search-box">
                <input type="text" id="vehicleSearch" placeholder="Tìm kiếm xe..." onkeyup="filterVehicles()">
            </div>
            
            <table class="table" id="vehicleTable">
                <thead>
                    <tr>
                        <th>ID Xe</th>
                        <th>Biển số</th>
                        <th>Tài xế</th>
                        <th>SĐT Tài xế</th>
                        <th>Ngày xuất xe</th>
                        <th>Ngày dự kiến</th>
                        <th>Trạng thái</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody id="vehicleTableBody">
                </tbody>
            </table>
        </div>

        <!-- Tab 2: Phân phối Đơn hàng -->
        <div id="assignments" class="tab-content">
            <div class="form-group">
                <button class="btn btn-success" onclick="showAssignmentModal()">Phân phối Đơn hàng</button>
                <button class="btn" onclick="sortBillsBySTT()" style="background: #f39c12; color: white;">Sắp xếp theo STT</button>
                <button class="btn" onclick="exportAssignmentsToPDF()" style="background: #e74c3c; color: white;">In PDF</button>
                <button class="btn" onclick="debugBills()" style="background: #9b59b6; color: white;">Debug Bills</button>
            </div>
            
            <div style="overflow-x: auto; max-height: 600px; overflow-y: auto;">
            <table class="table" id="assignmentTable">
                <thead>
                    <tr>
                            <th>STT</th>
                            <th>Số Bill</th>
                            <th>Ngày bốc</th>
                            <th>Mã khách gửi</th>
                            <th>Tên khách gửi</th>
                            <th>Xã</th>
                            <th>Địa chỉ</th>
                            <th>Địa chỉ đã lưu</th>
                            <th>Tên khách nhận</th>
                            <th>Địa chỉ nhận</th>
                            <th>Tỉnh nhận</th>
                            <th>Xã nhận</th>
                            <th>SĐT khách nhận</th>
                            <th>Dịch vụ GTGT</th>
                            <th>Nội dung hàng hóa</th>
                            <th>Số kiện</th>
                            <th>Trọng lượng thực</th>
                            <th>Thể tích</th>
                            <th>Đơn vị tính cước</th>
                            <th>Đơn giá</th>
                            <th>Phụ phí</th>
                            <th>VAT</th>
                            <th>Thành tiền</th>
                            <th>Người thanh toán</th>
                            <th>COD</th>
                            <th>Trạng thái thanh toán</th>
                        <th>Ghi chú</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody id="assignmentTableBody">
                </tbody>
            </table>
            </div>
        </div>

        <!-- Tab 3: Trạng thái Xe -->
        <div id="status" class="tab-content">
            <h3>Trạng thái các Xe</h3>
            <div id="vehicleStatusList">
            </div>
        </div>

        <!-- Tab 4: Đơn chưa xếp -->
        <div id="unassigned" class="tab-content">
            <h3>Đơn hàng chưa xếp hoặc xếp chưa hết</h3>
            <table class="table" id="unassignedTable">
                <thead>
                    <tr>
                        <th>ID Đơn hàng</th>
                        <th>Tên khách hàng</th>
                        <th>Số lượng tổng</th>
                        <th>Đã xếp</th>
                        <th>Còn lại</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody id="unassignedTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal Thêm/Sửa Xe -->
    <div id="vehicleModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeVehicleModal()">&times;</span>
            <h2 id="vehicleModalTitle">Thêm Xe mới</h2>
            <form id="vehicleForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>ID Xe:</label>
                        <input type="text" id="vehicleId" required>
                    </div>
                    <div class="form-group">
                        <label>Biển số:</label>
                        <input type="text" id="vehiclePlate" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Tài xế:</label>
                        <input type="text" id="vehicleDriver" required>
                    </div>
                    <div class="form-group">
                        <label>SĐT Tài xế:</label>
                        <input type="text" id="vehicleDriverPhone" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Ngày xuất xe:</label>
                        <input type="date" id="vehicleDepartureDate" required>
                    </div>
                    <div class="form-group">
                        <label>Ngày dự kiến:</label>
                        <input type="date" id="vehicleExpectedDate" readonly>
                    </div>
                </div>
                <div class="form-group">
                    <label>Trạng thái:</label>
                    <select id="vehicleStatus">
                        <option value="pending">Chờ xếp hàng</option>
                        <option value="in-transit">Đang vận chuyển</option>
                        <option value="delivered">Đã giao hàng</option>
                    </select>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-success">Lưu</button>
                    <button type="button" class="btn" onclick="closeVehicleModal()">Hủy</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Phân phối Đơn hàng -->
    <div id="assignmentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAssignmentModal()">&times;</span>
            <h2>Phân phối Đơn hàng</h2>
            <form id="assignmentForm">
                <div class="form-group">
                    <label>Chọn Xe:</label>
                    <select id="assignmentVehicle" required>
                        <option value="">-- Chọn xe --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Chọn Đơn hàng:</label>
                    <select id="assignmentBill" required>
                        <option value="">-- Chọn đơn hàng --</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Số thứ tự:</label>
                        <input type="number" id="assignmentOrder" min="1" required>
                    </div>
                    <div class="form-group">
                        <label>Số lượng hàng:</label>
                        <input type="number" id="assignmentQuantity" min="1" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Ghi chú:</label>
                    <textarea id="assignmentNote" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-success">Lưu</button>
                    <button type="button" class="btn" onclick="closeAssignmentModal()">Hủy</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Configuration
        const SHEET_ID = '1SbK_vKUJV7dTzDPmxmlEM-7MXBoh6guGRKU4dWvAiw4';
        const VEHICLE_SHEET = 'Xe';
        const BILL_SHEET = 'Bill';
        const ASSIGNMENT_SHEET = 'XepHang';
        const CUSTOMER_SHEET = 'Khách hàng';

        // Data storage
        let vehicles = [];
        let bills = [];
        let assignments = [];
        let customers = [];
        let currentVehicleId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadAllData();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Vehicle form
            document.getElementById('vehicleForm').addEventListener('submit', saveVehicle);
            document.getElementById('vehicleDepartureDate').addEventListener('change', calculateExpectedDate);
            
            // Assignment form
            document.getElementById('assignmentForm').addEventListener('submit', saveAssignment);
        }

        function calculateExpectedDate() {
            const departureDate = document.getElementById('vehicleDepartureDate').value;
            if (departureDate) {
                const date = new Date(departureDate);
                date.setDate(date.getDate() + 3);
                document.getElementById('vehicleExpectedDate').value = date.toISOString().split('T')[0];
            }
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Load data for specific tabs
            if (tabName === 'status') {
                loadVehicleStatus();
            } else if (tabName === 'unassigned') {
                loadUnassignedOrders();
            }
        }

        async function loadAllData() {
            try {
                await Promise.all([
                    loadVehicles(),
                    loadBills(),
                    loadAssignments(),
                    loadCustomers()
                ]);
                
                // Load local changes và merge vào data
                const localVehicles = readLocalVehicles();
                const localAssignments = readLocalAssignments();
                const localBills = readLocalBills();
                
                // Merge local vehicles
                localVehicles.forEach(localVehicle => {
                    const existingIndex = vehicles.findIndex(v => String(v.ID).toLowerCase() === String(localVehicle.ID).toLowerCase());
                    if (existingIndex >= 0) {
                        vehicles[existingIndex] = localVehicle;
                    } else {
                        vehicles.push(localVehicle);
                    }
                });
                
                // Merge local assignments
                localAssignments.forEach(localAssignment => {
                    const existingIndex = assignments.findIndex(a => String(a.ID).toLowerCase() === String(localAssignment.ID).toLowerCase());
                    if (existingIndex >= 0) {
                        assignments[existingIndex] = localAssignment;
                    } else {
                        assignments.push(localAssignment);
                    }
                });

                // Merge local bills
                localBills.forEach(localBill => {
                    const existingIndex = bills.findIndex(b => String(b['Số Bill']).toLowerCase() === String(localBill['Số Bill']).toLowerCase());
                    if (existingIndex >= 0) {
                        bills[existingIndex] = localBill;
                    } else {
                        bills.push(localBill);
                    }
                });
                
                renderAllTables();
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Lỗi tải dữ liệu: ' + error.message);
            }
        }

        async function loadVehicles() {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${VEHICLE_SHEET}&tqx=out:json`;
            const response = await fetch(url);
            const text = await response.text();
            const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
            
            vehicles = [];
            if (json.table && json.table.rows) {
                const headers = json.table.cols.map(c => c.label || '');
                console.log('Headers found:', headers); // Debug log
                
                json.table.rows.forEach((row, index) => {
                    const raw = {};
                    row.c.forEach((cell, i) => {
                        raw[headers[i]] = cell ? cell.v : '';
                    });
                    
                    // Map theo tên cột thực tế trong sheet xe của bạn
                    const vehicle = {
                        ID: raw['ID'] || raw['id'],
                        'Biển số': raw['Biển kiểm soát'] || raw['Bien kiem soat'],
                        'Tài xế': raw['Lái xe'] || raw['Lai xe'],
                        'SĐT Tài xế': raw['SBT lái xe'] || raw['SĐT lái xe'],
                        'Ngày xuất xe': raw['NgayXuat'] || raw['Ngày xuất'],
                        'Ngày dự kiến': raw['NgayDuKien'] || raw['Ngày dự kiến'],
                        'Trạng thái': raw['TrangThai'] || raw['Trạng thái'] || 'pending',
                        'Ghi chú': raw['GhiChu'] || raw['Ghi chú']
                    };
                    
                    if (vehicle.ID) {
                        vehicles.push(vehicle);
                        console.log('Loaded vehicle:', vehicle); // Debug log
                    }
                });
            }
            console.log('Total vehicles loaded:', vehicles.length); // Debug log
        }

        async function loadBills() {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${BILL_SHEET}&tqx=out:json`;
            const response = await fetch(url);
            const text = await response.text();
            const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
            
            bills = [];
            if (json.table && json.table.rows) {
                const headers = json.table.cols.map(c => c.label || '');
                console.log('Bill headers found:', headers); // Debug log
                
                json.table.rows.forEach((row, index) => {
                    if (index === 0) return; // Skip header
                    const raw = {};
                    row.c.forEach((cell, i) => {
                        raw[headers[i]] = cell ? cell.v : '';
                    });
                    
                    // Map tất cả các trường từ sheet Bill
                    const bill = {
                        'STT': raw['STT'] || raw['stt'] || (index),
                        'Số Bill': raw['Số Bill'] || raw['So Bill'] || raw['Số bill'],
                        'Ngày bốc': raw['Ngày bốc'] || raw['Ngay boc'],
                        'Mã khách gửi': raw['Mã khách gửi'] || raw['Ma khach gui'],
                        'Tên khách gửi': raw['Tên khách gửi'] || raw['Ten khach gui'],
                        'Xã': raw['Xã'] || raw['Xa'],
                        'Địa chỉ': raw['Địa chỉ'] || raw['Dia chi'],
                        'Địa chỉ đã lưu': raw['Địa chỉ đã lưu'] || raw['Dia chi da luu'],
                        'Tên khách nhận': raw['Tên khách nhận'] || raw['Ten khach nhan'],
                        'Địa chỉ nhận': raw['Địa chỉ nhận'] || raw['Dia chi nhan'],
                        'Tỉnh nhận': raw['Tỉnh nhận'] || raw['Tinh nhan'],
                        'Xã nhận': raw['Xã nhận'] || raw['Xa nhan'],
                        'SĐT khách nhận': raw['SĐT khách nhận'] || raw['SDT khach nhan'],
                        'Dịch vụ GTGT': raw['Dịch vụ GTGT'] || raw['Dich vu GTGT'],
                        'Nội dung hàng hóa': raw['Nội dung hàng hóa'] || raw['Noi dung hang hoa'],
                        'Số kiện': raw['Số kiện'] || raw['So kien'],
                        'Trọng lượng thực': raw['Trọng lượng thực'] || raw['Trong luong thuc'],
                        'Thể tích': raw['Thể tích'] || raw['The tich'],
                        'Đơn vị tính cước': raw['Đơn vị tính cước'] || raw['Don vi tinh cuoc'],
                        'Đơn giá': raw['Đơn giá'] || raw['Don gia'],
                        'Phụ phí': raw['Phụ phí'] || raw['Phu phi'],
                        'VAT': raw['VAT'] || raw['vat'],
                        'Thành tiền': raw['Thành tiền'] || raw['Thanh tien'],
                        'Người thanh toán': raw['Người thanh toán'] || raw['Nguoi thanh toan'],
                        'COD': raw['COD'] || raw['cod'],
                        'Trạng thái thanh toán': raw['Trạng thái thanh toán'] || raw['Trang thai thanh toan'],
                        'Ghi chú': raw['Ghi chú'] || raw['Ghi chu']
                    };
                    
                    if (bill['Số Bill']) {
                        bills.push(bill);
                        console.log('Loaded bill:', bill); // Debug log
                    }
                });
            }
            console.log('Total bills loaded:', bills.length); // Debug log
        }

        async function loadAssignments() {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${ASSIGNMENT_SHEET}&tqx=out:json`;
            const response = await fetch(url);
            const text = await response.text();
            const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
            
            assignments = [];
            if (json.table && json.table.rows) {
                const headers = json.table.cols.map(c => c.label || '');
                json.table.rows.forEach((row, index) => {
                    if (index === 0) return; // Skip header
                    const assignment = {};
                    row.c.forEach((cell, i) => {
                        assignment[headers[i]] = cell ? cell.v : '';
                    });
                    if (assignment.ID) assignments.push(assignment);
                });
            }
        }

        async function loadCustomers() {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${CUSTOMER_SHEET}&tqx=out:json`;
            const response = await fetch(url);
            const text = await response.text();
            const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
            
            customers = [];
            if (json.table && json.table.rows) {
                const headers = json.table.cols.map(c => c.label || '');
                json.table.rows.forEach((row, index) => {
                    if (index === 0) return; // Skip header
                    const customer = {};
                    row.c.forEach((cell, i) => {
                        customer[headers[i]] = cell ? cell.v : '';
                    });
                    if (customer.ID) customers.push(customer);
                });
            }
        }

        function renderAllTables() {
            renderVehicleTable();
            renderAssignmentTable();
            loadVehicleStatus();
            loadUnassignedOrders();
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                // Xử lý định dạng Date(YYYY,M,D)
                if (typeof dateString === 'string' && dateString.startsWith('Date(')) {
                    const match = dateString.match(/Date\((\d+),(\d+),(\d+)\)/);
                    if (match) {
                        const year = parseInt(match[1]);
                        const month = parseInt(match[2]) + 1; // Month is 0-indexed in Date()
                        const day = parseInt(match[3]);
                        const date = new Date(year, month - 1, day);
                        return date.toISOString().split('T')[0]; // YYYY-MM-DD format
                    }
                }
                
                // Xử lý định dạng thông thường
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString;
                return date.toISOString().split('T')[0]; // YYYY-MM-DD format
            } catch (error) {
                return dateString;
            }
        }

        function renderVehicleTable() {
            const tbody = document.getElementById('vehicleTableBody');
            tbody.innerHTML = '';
            
            vehicles.forEach(vehicle => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${vehicle.ID || ''}</td>
                    <td>${vehicle['Biển số'] || ''}</td>
                    <td>${vehicle['Tài xế'] || ''}</td>
                    <td>${vehicle['SĐT Tài xế'] || ''}</td>
                    <td>${formatDate(vehicle['Ngày xuất xe'])}</td>
                    <td>${formatDate(vehicle['Ngày dự kiến'])}</td>
                    <td><span class="status-badge status-${vehicle['Trạng thái'] || 'pending'}">${getStatusText(vehicle['Trạng thái'])}</span></td>
                    <td>
                        <button class="btn" onclick="editVehicle('${vehicle.ID}')">Sửa</button>
                        <button class="btn btn-danger" onclick="deleteVehicle('${vehicle.ID}')">Xóa</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderAssignmentTable() {
            const tbody = document.getElementById('assignmentTableBody');
            tbody.innerHTML = '';
            
            // Hiển thị dữ liệu từ sheet Bill
            bills.forEach((bill, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <input type="number" 
                               value="${bill['STT'] || (index + 1)}" 
                               min="1" 
                               style="width: 60px; padding: 4px; border: 1px solid #ddd; border-radius: 3px;"
                               onchange="updateBillSTT('${bill['Số Bill']}', this.value)"
                               onblur="updateBillSTT('${bill['Số Bill']}', this.value)">
                    </td>
                    <td>${bill['Số Bill'] || ''}</td>
                    <td>${formatDate(bill['Ngày bốc']) || ''}</td>
                    <td>${bill['Mã khách gửi'] || ''}</td>
                    <td>${bill['Tên khách gửi'] || ''}</td>
                    <td>${bill['Xã'] || ''}</td>
                    <td>${bill['Địa chỉ'] || ''}</td>
                    <td>${bill['Địa chỉ đã lưu'] || ''}</td>
                    <td>${bill['Tên khách nhận'] || ''}</td>
                    <td>${bill['Địa chỉ nhận'] || ''}</td>
                    <td>${bill['Tỉnh nhận'] || ''}</td>
                    <td>${bill['Xã nhận'] || ''}</td>
                    <td>${bill['SĐT khách nhận'] || ''}</td>
                    <td>${bill['Dịch vụ GTGT'] || ''}</td>
                    <td>${bill['Nội dung hàng hóa'] || ''}</td>
                    <td>${bill['Số kiện'] || ''}</td>
                    <td>${bill['Trọng lượng thực'] || ''}</td>
                    <td>${bill['Thể tích'] || ''}</td>
                    <td>${bill['Đơn vị tính cước'] || ''}</td>
                    <td>${bill['Đơn giá'] || ''}</td>
                    <td>${bill['Phụ phí'] || ''}</td>
                    <td>${bill['VAT'] || ''}</td>
                    <td>${bill['Thành tiền'] || ''}</td>
                    <td>${bill['Người thanh toán'] || ''}</td>
                    <td>${bill['COD'] || ''}</td>
                    <td>${bill['Trạng thái thanh toán'] || ''}</td>
                    <td>${bill['Ghi chú'] || ''}</td>
                    <td>
                        <button class="btn" onclick="editBill('${bill['Số Bill']}')">Sửa</button>
                        <button class="btn btn-danger" onclick="deleteBill('${bill['Số Bill']}')">Xóa</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadVehicleStatus() {
            const container = document.getElementById('vehicleStatusList');
            container.innerHTML = '';
            
            vehicles.forEach(vehicle => {
                const vehicleAssignments = assignments.filter(a => a['Xe'] === vehicle.ID);
                const div = document.createElement('div');
                div.style.cssText = 'border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 5px;';
                div.innerHTML = `
                    <h4>Xe ${vehicle['Biển số']} - ${vehicle['Tài xế']} <span class="status-badge status-${vehicle['Trạng thái'] || 'pending'}">${getStatusText(vehicle['Trạng thái'])}</span></h4>
                    <p><strong>Ngày xuất xe:</strong> ${formatDate(vehicle['Ngày xuất xe'])}</p>
                    <p><strong>Ngày dự kiến:</strong> ${formatDate(vehicle['Ngày dự kiến'])}</p>
                    <h5>Đơn hàng đã xếp:</h5>
                    <ul>
                        ${vehicleAssignments.map(a => {
                            const bill = bills.find(b => b.ID === a['Bill']);
                            return `<li>${bill ? bill['Tên đơn hàng'] : a['Bill']} - Số lượng: ${a['Số lượng hàng']}</li>`;
                        }).join('')}
                    </ul>
                `;
                container.appendChild(div);
            });
        }

        function loadUnassignedOrders() {
            const tbody = document.getElementById('unassignedTableBody');
            tbody.innerHTML = '';
            
            bills.forEach(bill => {
                const billAssignments = assignments.filter(a => a['Bill'] === bill.ID);
                const totalAssigned = billAssignments.reduce((sum, a) => sum + (parseInt(a['Số lượng hàng']) || 0), 0);
                const totalQuantity = parseInt(bill['Số lượng'] || 0);
                const remaining = totalQuantity - totalAssigned;
                
                if (remaining > 0) {
                    const customer = customers.find(c => c.ID === bill['Khách hàng']);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${bill.ID || ''}</td>
                        <td>${customer ? customer['Tên khách hàng'] : bill['Khách hàng']}</td>
                        <td>${totalQuantity}</td>
                        <td>${totalAssigned}</td>
                        <td>${remaining}</td>
                        <td>
                            <button class="btn btn-success" onclick="assignBill('${bill.ID}')">Xếp hàng</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                }
            });
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'Chờ xếp hàng',
                'in-transit': 'Đang vận chuyển',
                'delivered': 'Đã giao hàng'
            };
            return statusMap[status] || 'Chờ xếp hàng';
        }

        function showVehicleModal(vehicleId = null) {
            currentVehicleId = vehicleId;
            const modal = document.getElementById('vehicleModal');
            const title = document.getElementById('vehicleModalTitle');
            const form = document.getElementById('vehicleForm');
            
            if (vehicleId) {
                title.textContent = 'Sửa Xe';
                const vehicle = vehicles.find(v => v.ID === vehicleId);
                if (vehicle) {
                    document.getElementById('vehicleId').value = vehicle.ID;
                    document.getElementById('vehiclePlate').value = vehicle['Biển số'] || '';
                    document.getElementById('vehicleDriver').value = vehicle['Tài xế'] || '';
                    document.getElementById('vehicleDriverPhone').value = vehicle['SĐT Tài xế'] || '';
                    document.getElementById('vehicleDepartureDate').value = vehicle['Ngày xuất xe'] || '';
                    document.getElementById('vehicleExpectedDate').value = vehicle['Ngày dự kiến'] || '';
                    document.getElementById('vehicleStatus').value = vehicle['Trạng thái'] || 'pending';
                }
            } else {
                title.textContent = 'Thêm Xe mới';
                form.reset();
            }
            
            modal.style.display = 'block';
        }

        function closeVehicleModal() {
            document.getElementById('vehicleModal').style.display = 'none';
            currentVehicleId = null;
        }

        function showAssignmentModal(assignmentId = null) {
            const modal = document.getElementById('assignmentModal');
            const vehicleSelect = document.getElementById('assignmentVehicle');
            const billSelect = document.getElementById('assignmentBill');
            
            // Populate vehicle options
            vehicleSelect.innerHTML = '<option value="">-- Chọn xe --</option>';
            vehicles.forEach(vehicle => {
                const option = document.createElement('option');
                option.value = vehicle.ID;
                option.textContent = `${vehicle['Biển số']} - ${vehicle['Tài xế']}`;
                vehicleSelect.appendChild(option);
            });
            
            // Populate bill options
            billSelect.innerHTML = '<option value="">-- Chọn đơn hàng --</option>';
            bills.forEach(bill => {
                const option = document.createElement('option');
                option.value = bill.ID;
                option.textContent = `${bill['Tên đơn hàng']} - ${bill['Số lượng']} đơn vị`;
                billSelect.appendChild(option);
            });
            
            modal.style.display = 'block';
        }

        function closeAssignmentModal() {
            document.getElementById('assignmentModal').style.display = 'none';
        }

        function assignBill(billId) {
            showAssignmentModal();
            document.getElementById('assignmentBill').value = billId;
        }

        function filterVehicles() {
            const searchTerm = document.getElementById('vehicleSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#vehicleTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // Local storage fallback (giống index.html)
        const LS_KEY_VEHICLES = 'goixe_vehicles_v1';
        const LS_KEY_ASSIGNMENTS = 'goixe_assignments_v1';
        
        function readLocalVehicles() {
            try { return JSON.parse(localStorage.getItem(LS_KEY_VEHICLES) || '[]'); } catch { return []; }
        }
        function writeLocalVehicles(data) {
            localStorage.setItem(LS_KEY_VEHICLES, JSON.stringify(data));
        }
        function readLocalAssignments() {
            try { return JSON.parse(localStorage.getItem(LS_KEY_ASSIGNMENTS) || '[]'); } catch { return []; }
        }
        function writeLocalAssignments(data) {
            localStorage.setItem(LS_KEY_ASSIGNMENTS, JSON.stringify(data));
        }
        
        function upsertLocalVehicle(vehicle) {
            const arr = readLocalVehicles();
            const idx = arr.findIndex(x => String(x.ID).toLowerCase() === String(vehicle.ID).toLowerCase());
            if (idx >= 0) arr[idx] = vehicle; else arr.push(vehicle);
            writeLocalVehicles(arr);
        }
        
        function removeLocalVehicle(id) {
            const arr = readLocalVehicles().filter(x => String(x.ID).toLowerCase() !== String(id).toLowerCase());
            writeLocalVehicles(arr);
        }

        async function saveVehicle(event) {
            event.preventDefault();
            
            const vehicleData = {
                ID: document.getElementById('vehicleId').value,
                'Biển kiểm soát': document.getElementById('vehiclePlate').value,
                'Lái xe': document.getElementById('vehicleDriver').value,
                'SBT lái xe': document.getElementById('vehicleDriverPhone').value,
                'NgayXuat': document.getElementById('vehicleDepartureDate').value,
                'NgayDuKien': document.getElementById('vehicleExpectedDate').value,
                'TrangThai': document.getElementById('vehicleStatus').value,
                'GhiChu': document.getElementById('vehicleNote')?.value || ''
            };
            
            // Cập nhật local data trước
            if (currentVehicleId) {
                const index = vehicles.findIndex(v => v.ID === currentVehicleId);
                if (index !== -1) {
                    vehicles[index] = vehicleData;
                }
            } else {
                vehicles.push(vehicleData);
            }
            
            try {
                // Thử gửi lên API để lưu vào Google Sheet
                const response = await fetch('/api/report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'update',
                        sheetId: SHEET_ID,
                        sheetName: VEHICLE_SHEET,
                        data: vehicleData
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Lỗi lưu vào sheet');
                }
                
                // Thành công: lưu vào localStorage làm backup
                upsertLocalVehicle(vehicleData);
                renderVehicleTable();
                closeVehicleModal();
                alert('Đã lưu xe vào Google Sheet thành công!');
                
            } catch (error) {
                console.error('Error saving vehicle:', error);
                // Fallback: chỉ lưu local
                upsertLocalVehicle(vehicleData);
                renderVehicleTable();
                closeVehicleModal();
                alert('Đã lưu xe tạm trên trình duyệt (chưa ghi vào Sheet). Lỗi: ' + error.message);
            }
        }

        function upsertLocalAssignment(assignment) {
            const arr = readLocalAssignments();
            const idx = arr.findIndex(x => String(x.ID).toLowerCase() === String(assignment.ID).toLowerCase());
            if (idx >= 0) arr[idx] = assignment; else arr.push(assignment);
            writeLocalAssignments(arr);
        }

        async function saveAssignment(event) {
            event.preventDefault();
            
            const assignmentData = {
                ID: 'ASS' + Date.now(),
                'Xe': document.getElementById('assignmentVehicle').value,
                'Bill': document.getElementById('assignmentBill').value,
                'Số thứ tự': document.getElementById('assignmentOrder').value,
                'Số lượng hàng': document.getElementById('assignmentQuantity').value,
                'Ghi chú': document.getElementById('assignmentNote').value
            };
            
            // Cập nhật local data trước
            assignments.push(assignmentData);
            
            try {
                // Thử gửi lên API để lưu vào Google Sheet
                const response = await fetch('/api/report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'update',
                        sheetId: SHEET_ID,
                        sheetName: ASSIGNMENT_SHEET,
                        data: assignmentData
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Lỗi lưu phân phối vào sheet');
                }
                
                // Thành công: lưu vào localStorage làm backup
                upsertLocalAssignment(assignmentData);
                renderAssignmentTable();
                loadUnassignedOrders();
                closeAssignmentModal();
                alert('Đã phân phối đơn hàng vào Google Sheet thành công!');
                
            } catch (error) {
                console.error('Error saving assignment:', error);
                // Fallback: chỉ lưu local
                upsertLocalAssignment(assignmentData);
                renderAssignmentTable();
                loadUnassignedOrders();
                closeAssignmentModal();
                alert('Đã phân phối đơn hàng tạm trên trình duyệt (chưa ghi vào Sheet). Lỗi: ' + error.message);
            }
        }

        function editVehicle(vehicleId) {
            showVehicleModal(vehicleId);
        }

        async function deleteVehicle(vehicleId) {
            if (confirm('Bạn có chắc muốn xóa xe này?')) {
                // Cập nhật local data trước
                vehicles = vehicles.filter(v => v.ID !== vehicleId);
                assignments = assignments.filter(a => a['Xe'] !== vehicleId);
                
                try {
                    // Thử gửi lên API để xóa khỏi Google Sheet
                    const response = await fetch('/api/report', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'delete',
                            sheetId: SHEET_ID,
                            sheetName: VEHICLE_SHEET,
                            id: vehicleId
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Lỗi xóa khỏi sheet');
                    }
                    
                    // Thành công: xóa khỏi localStorage
                    removeLocalVehicle(vehicleId);
                    renderAllTables();
                    alert('Đã xóa xe khỏi Google Sheet thành công!');
                    
                } catch (error) {
                    console.error('Error deleting vehicle:', error);
                    // Fallback: chỉ xóa local
                    removeLocalVehicle(vehicleId);
                    renderAllTables();
                    alert('Đã xóa xe tạm trên trình duyệt (chưa xóa khỏi Sheet). Lỗi: ' + error.message);
                }
            }
        }

        function editAssignment(assignmentId) {
            // Implementation for editing assignment
            alert('Chức năng sửa phân phối đang được phát triển');
        }

        function updateAssignmentOrder(assignmentId, newOrder) {
            const assignment = assignments.find(a => a.ID === assignmentId);
            if (assignment) {
                assignment['Số thứ tự'] = parseInt(newOrder) || 1;
                
                // Cập nhật local storage
                upsertLocalAssignment(assignment);
                
                // Tự động sắp xếp lại table
                renderAssignmentTable();
                
                console.log(`Updated assignment ${assignmentId} order to ${newOrder}`);
            }
        }

        function updateBillSTT(billNumber, newSTT) {
            const bill = bills.find(b => b['Số Bill'] === billNumber);
            if (bill) {
                bill['STT'] = parseInt(newSTT) || 1;
                
                // Cập nhật local storage
                upsertLocalBill(bill);
                
                // Cập nhật vào Google Sheet
                updateBillSTTInSheet(bill);
                
                // Tự động sắp xếp lại table
                renderAssignmentTable();
                
                console.log(`Updated bill ${billNumber} STT to ${newSTT}`);
            }
        }

        async function updateBillSTTInSheet(bill) {
            try {
                const response = await fetch('/api/report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'updateBillSTT',
                        sheetId: SHEET_ID,
                        sheetName: BILL_SHEET,
                        billNumber: bill['Số Bill'],
                        stt: bill['STT']
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Lỗi cập nhật STT vào sheet');
                }
                
                console.log('STT updated in sheet successfully');
            } catch (error) {
                console.error('Error updating STT in sheet:', error);
                // Không hiển thị lỗi cho user để không làm gián đoạn workflow
            }
        }

        async function sortBillsBySTT() {
            try {
                console.log('Bắt đầu sắp xếp STT...');
                console.log('Tổng số bills trước khi sắp xếp:', bills.length);
                
                // Sắp xếp bills theo STT
                bills.sort((a, b) => {
                    const sttA = parseInt(a['STT']) || 0;
                    const sttB = parseInt(b['STT']) || 0;
                    return sttA - sttB;
                });
                
                // Cập nhật lại STT liên tiếp
                bills.forEach((bill, index) => {
                    bill['STT'] = index + 1;
                    upsertLocalBill(bill);
                });
                
                console.log('Đã cập nhật STT local, đang gửi lên Google Sheet...');
                console.log('Bills sau khi sắp xếp:', bills.map(b => ({ 'Số Bill': b['Số Bill'], 'STT': b['STT'] })));
                
                // Cập nhật tất cả STT vào sheet
                const result = await updateAllSTTInSheet();
                
                // Render lại table
                renderAssignmentTable();
                
                if (result && result.success) {
                    alert(`Đã sắp xếp và cập nhật STT thành công!\nCập nhật: ${result.updated}/${bills.length} items`);
                } else {
                    alert(`Đã sắp xếp thành công và lưu tạm trên trình duyệt.\nCập nhật Sheet: ${result ? result.updated : 0}/${bills.length} items\n\nVui lòng kiểm tra kết nối API.`);
                }
                
            } catch (error) {
                console.error('Error in sortBillsBySTT:', error);
                alert('Lỗi khi sắp xếp STT: ' + error.message);
            }
        }

        async function updateAllSTTInSheet() {
            try {
                console.log('Đang cập nhật STT lên Google Sheet...');
                console.log('SHEET_ID:', SHEET_ID);
                console.log('BILL_SHEET:', BILL_SHEET);
                console.log('Bills to update:', bills.length);
                console.log('Bills data:', bills.map(b => ({ 'Số Bill': b['Số Bill'], 'STT': b['STT'] })));
                
                const response = await fetch('/api/report', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'updateAllSTT',
                        sheetId: SHEET_ID,
                        sheetName: BILL_SHEET,
                        bills: bills
                    })
                });
                
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error Response:', errorText);
                    throw new Error(`Lỗi API: ${response.status} - ${errorText}`);
                }
                
                const result = await response.json();
                console.log('API Success Response:', result);
                
                if (result.ok) {
                    console.log('All STT updated in sheet successfully');
                    return {
                        success: true,
                        updated: result.updated || bills.length,
                        total: bills.length,
                        message: result.message || 'Cập nhật thành công'
                    };
                } else {
                    throw new Error(result.error || 'Lỗi không xác định từ API');
                }
                
            } catch (error) {
                console.error('Error updating all STT in sheet:', error);
                
                // Fallback: Lưu vào localStorage
                bills.forEach(bill => {
                    upsertLocalBill(bill);
                });
                
                return {
                    success: false,
                    updated: 0,
                    total: bills.length,
                    error: error.message
                };
            }
        }

        function upsertLocalBill(bill) {
            const arr = readLocalBills();
            const idx = arr.findIndex(x => String(x['Số Bill']).toLowerCase() === String(bill['Số Bill']).toLowerCase());
            if (idx >= 0) arr[idx] = bill; else arr.push(bill);
            writeLocalBills(arr);
        }

        // Function để debug và kiểm tra bills
        function debugBills() {
            console.log('=== DEBUG BILLS ===');
            console.log('Tổng số bills:', bills.length);
            console.log('Bills details:');
            bills.forEach((bill, index) => {
                console.log(`${index + 1}. Số Bill: "${bill['Số Bill']}", STT: ${bill['STT']}`);
            });
            
            // Kiểm tra bills có STT trùng lặp
            const sttCounts = {};
            bills.forEach(bill => {
                const stt = bill['STT'];
                sttCounts[stt] = (sttCounts[stt] || 0) + 1;
            });
            
            const duplicates = Object.entries(sttCounts).filter(([stt, count]) => count > 1);
            if (duplicates.length > 0) {
                console.warn('STT trùng lặp:', duplicates);
            }
            
            // Kiểm tra bills có Số Bill trống
            const emptyBills = bills.filter(bill => !bill['Số Bill'] || bill['Số Bill'].trim() === '');
            if (emptyBills.length > 0) {
                console.warn('Bills có Số Bill trống:', emptyBills.length);
            }
            
            console.log('=== END DEBUG ===');
        }

        function readLocalBills() {
            try { return JSON.parse(localStorage.getItem('goixe_bills_v1') || '[]'); } catch { return []; }
        }

        function writeLocalBills(data) {
            localStorage.setItem('goixe_bills_v1', JSON.stringify(data));
        }

        function editBill(billNumber) {
            alert('Chức năng sửa Bill đang được phát triển');
        }

        function deleteBill(billNumber) {
            if (confirm('Bạn có chắc muốn xóa Bill này?')) {
                bills = bills.filter(b => b['Số Bill'] !== billNumber);
                renderAssignmentTable();
                alert('Đã xóa Bill thành công!');
            }
        }

        // Function to properly encode Vietnamese text for PDF
        function encodeVietnameseText(text) {
            if (!text) return '';
            // Keep Vietnamese characters with diacritics intact
            return String(text);
        }

        function exportAssignmentsToPDF() {
            try {
                // Tạo một div ẩn để chứa bảng cho PDF
                const printDiv = document.createElement('div');
                printDiv.style.cssText = `
                    position: absolute;
                    left: -9999px;
                    top: -9999px;
                    width: 297mm;
                    background: white;
                    font-family: 'Segoe UI', 'Arial Unicode MS', 'Arial', 'Tahoma', sans-serif;
                    font-size: 12px;
                    line-height: 1.4;
                `;
                
                // Tạo header
                const header = document.createElement('div');
                header.style.cssText = 'text-align: center; margin-bottom: 20px;';
                header.innerHTML = `
                    <h1 style="font-size: 18px; margin: 0; color: #2c3e50;">BÁO CÁO ĐƠN HÀNG BILL</h1>
                    <p style="font-size: 12px; margin: 5px 0; color: #666;">Ngày xuất báo cáo: ${new Date().toLocaleDateString('vi-VN')}</p>
                `;
                printDiv.appendChild(header);
                
                // Tạo bảng
                const table = document.createElement('table');
                table.style.cssText = `
                    width: 100%;
                    border-collapse: collapse;
                    font-size: 10px;
                    margin-bottom: 20px;
                `;
                
                // Header của bảng
                const thead = document.createElement('thead');
                thead.innerHTML = `
                    <tr style="background-color: #34495e; color: white;">
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">STT</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Số Bill</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Ngày bốc</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Khách gửi</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Khách nhận</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Địa chỉ nhận</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Tỉnh</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Nội dung</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Số kiện</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Trọng lượng</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Thành tiền</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Trạng thái</th>
                    </tr>
                `;
                table.appendChild(thead);
                
                // Body của bảng
                const tbody = document.createElement('tbody');
                
                // Sắp xếp bills theo STT
                const sortedBills = [...bills].sort((a, b) => {
                    const sttA = parseInt(a['STT']) || 0;
                    const sttB = parseInt(b['STT']) || 0;
                    return sttA - sttB;
                });
                
                sortedBills.forEach((bill, index) => {
                    const row = document.createElement('tr');
                    row.style.cssText = index % 2 === 0 ? 'background-color: #f8f9fa;' : 'background-color: white;';
                    row.innerHTML = `
                        <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${bill['STT'] || (index + 1)}</td>
                        <td style="border: 1px solid #ddd; padding: 6px;">${bill['Số Bill'] || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 6px;">${formatDate(bill['Ngày bốc']) || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 6px;">${bill['Tên khách gửi'] || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 6px;">${bill['Tên khách nhận'] || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 6px; max-width: 100px; word-wrap: break-word;">${bill['Địa chỉ nhận'] || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 6px;">${bill['Tỉnh nhận'] || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 6px; max-width: 80px; word-wrap: break-word;">${bill['Nội dung hàng hóa'] || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${bill['Số kiện'] || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${bill['Trọng lượng thực'] || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 6px; text-align: center;">${bill['Thành tiền'] || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 6px;">${bill['Trạng thái thanh toán'] || ''}</td>
                    `;
                    tbody.appendChild(row);
                });
                
                table.appendChild(tbody);
                printDiv.appendChild(table);
                
                // Footer
                const footer = document.createElement('div');
                footer.style.cssText = 'text-align: center; margin-top: 20px; font-size: 12px;';
                footer.innerHTML = `<p><strong>Tổng số đơn hàng: ${bills.length}</strong></p>`;
                printDiv.appendChild(footer);
                
                // Thêm vào DOM
                document.body.appendChild(printDiv);
                
                // Chụp ảnh và tạo PDF
                html2canvas(printDiv, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff'
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('l', 'mm', 'a4');
                    
                    const imgWidth = 297; // A4 width in mm
                    const pageHeight = 210; // A4 height in mm
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    let heightLeft = imgHeight;
                    
                    let position = 0;
                    
                    doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                    
                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        doc.addPage();
                        doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                
                // Lưu file
                const fileName = `Bao_cao_don_hang_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                    // Xóa div tạm
                    document.body.removeChild(printDiv);
                    
                    alert('Đã xuất PDF thành công với ký tự tiếng Việt đầy đủ!');
                }).catch(error => {
                    console.error('Error generating PDF:', error);
                    document.body.removeChild(printDiv);
                    alert('Lỗi khi xuất PDF: ' + error.message);
                });
                
            } catch (error) {
                console.error('Error exporting PDF:', error);
                alert('Lỗi khi xuất PDF: ' + error.message);
            }
        }

        function deleteAssignment(assignmentId) {
            if (confirm('Bạn có chắc muốn xóa phân phối này?')) {
                assignments = assignments.filter(a => a.ID !== assignmentId);
                renderAssignmentTable();
                loadUnassignedOrders();
                alert('Đã xóa phân phối thành công!');
            }
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const vehicleModal = document.getElementById('vehicleModal');
            const assignmentModal = document.getElementById('assignmentModal');
            
            if (event.target === vehicleModal) {
                closeVehicleModal();
            }
            if (event.target === assignmentModal) {
                closeAssignmentModal();
            }
        }
    </script>
</body>
</html>
