<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Quản lý Xe và Đơn hàng</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', 'Arial Unicode MS', 'Arial', 'Tahoma', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }
        .nav-tabs {
            display: flex;
            background: #34495e;
            border-bottom: 1px solid #2c3e50;
        }
        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            color: #ecf0f1;
            border-right: 1px solid #2c3e50;
            transition: background 0.3s;
        }
        .nav-tab:last-child {
            border-right: none;
        }
        .nav-tab.active {
            background: #3498db;
        }
        .nav-tab:hover {
            background: #2980b9;
        }
        .tab-content {
            display: none;
            padding: 20px;
        }
        .tab-content.active {
            display: block;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 14px;
        }
        .form-row {
            display: flex;
            gap: 15px;
        }
        .form-row .form-group {
            flex: 1;
        }
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        .btn:hover {
            background: #2980b9;
        }
        .btn-success {
            background: #27ae60;
        }
        .btn-success:hover {
            background: #229954;
        }
        .btn-danger {
            background: #e74c3c;
        }
        .btn-danger:hover {
            background: #c0392b;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #bdc3c7;
        }
        .table th {
            background: #ecf0f1;
            font-weight: bold;
            color: #2c3e50;
        }
        .table tr:hover {
            background: #f8f9fa;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-pending {
            background: #f39c12;
            color: white;
        }
        .status-in-transit {
            background: #3498db;
            color: white;
        }
        .status-delivered {
            background: #27ae60;
            color: white;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: #000;
        }
        .search-box {
            margin-bottom: 20px;
        }
        .search-box input {
            width: 300px;
            padding: 8px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
        }
        
        /* Print styles */
        @media print {
            .nav-tabs, .form-group, .btn, .search-box {
                display: none !important;
            }
            .container {
                box-shadow: none;
                margin: 0;
                padding: 0;
                width: 100% !important;
            }
            .header {
                background: white !important;
                color: black !important;
                padding: 10px 0;
            }
            .table {
                font-size: 6px !important;
                width: 100% !important;
                table-layout: fixed;
            }
            .table th, .table td {
                padding: 2px !important;
                border: 1px solid #000 !important;
                word-wrap: break-word;
                overflow: hidden;
                white-space: nowrap;
            }
            body {
                margin: 0;
                padding: 5px;
            }
            @page {
                margin: 0.3in;
                size: A4 landscape;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Quản lý Xe và Đơn hàng</h1>
            <p>Hệ thống quản lý xe vận tải và phân phối đơn hàng</p>
        </div>

        <div class="nav-tabs">
            <div class="nav-tab active" onclick="showTab('vehicles')">Quản lý Xe</div>
            <div class="nav-tab" onclick="showTab('assignments')">Phân phối Đơn hàng</div>
            <div class="nav-tab" onclick="showTab('status')">Trạng thái Xe</div>
            <div class="nav-tab" onclick="showTab('unassigned')">Xếp hàng</div>
        </div>

        <!-- Tab 1: Quản lý Xe -->
        <div id="vehicles" class="tab-content active">
            <div class="form-group">
                <button class="btn btn-success" onclick="showVehicleModal()">Thêm Xe mới</button>
            </div>
            
            <!-- Bộ lọc xe -->
            <div class="form-row" style="margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 5px;">
                <div class="form-group">
                    <label>Lọc theo ngày xuất xe:</label>
                    <input type="date" id="filterVehicleDate" onchange="filterVehicles()">
                </div>
                <div class="form-group">
                    <label>Lọc theo nhà cung cấp:</label>
                    <select id="filterVehicleSupplier" onchange="filterVehicles()">
                        <option value="">-- Tất cả nhà cung cấp --</option>
                        <option value="XELE">XELE - Xe lẻ</option>
                        <option value="CHIEN3C">CHIEN3C - Chiến 3 chân</option>
                        <option value="DUNG3C">DUNG3C - Dũng 3 chân</option>
                        <option value="VIETTEL48">VIETTEL48 - Viettel tàu 48h</option>
                        <option value="SONGTR">SONGTR - Song Trường Cont</option>
                        <option value="TINH3C">TINH3C - Tình 3 chân</option>
                        <option value="VIC">VIC - XE VIC</option>
                        <option value="BFY72">BFY72 - BFY Tàu 72h</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Lọc theo trạng thái:</label>
                    <select id="filterVehicleStatus" onchange="filterVehicles()">
                        <option value="">-- Tất cả trạng thái --</option>
                        <option value="pending">Chờ xếp hàng</option>
                        <option value="in-transit">Đang vận chuyển</option>
                        <option value="delivered">Đã giao hàng</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button class="btn" onclick="clearVehicleFilters()" style="background: #95a5a6; color: white;">Xóa bộ lọc</button>
                </div>
            </div>
            
            <div class="search-box">
                <input type="text" id="vehicleSearch" placeholder="Tìm kiếm xe..." onkeyup="filterVehicles()">
            </div>
            
            <table class="table" id="vehicleTable">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Ngày xuất xe</th>
                        <th>Trạng thái</th>
                        <th>Ghi chú</th>
                        <th>Ngày dự kiến</th>
                        <th>Tên nhà cung cấp</th>
                        <th>Trạng thái thanh toán</th>
                        <th>Biển kiểm soát</th>
                        <th>Lái xe</th>
                        <th>SBT lái xe</th>
                        <th>Ghi chú bổ sung</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody id="vehicleTableBody">
                </tbody>
            </table>
        </div>

        <!-- Tab 2: Phân phối Đơn hàng -->
        <div id="assignments" class="tab-content">
            <div class="form-group">
                <button class="btn btn-success" onclick="showAssignmentModal()">Phân phối Đơn hàng</button>
                <button class="btn" onclick="sortBillsBySTT()" style="background: #f39c12; color: white;">Sắp xếp theo STT tùy chỉnh</button>
                <button class="btn" onclick="printAssignments()" style="background: #e74c3c; color: white;">In</button>
            </div>
            
            <div style="overflow-x: auto; max-height: 600px; overflow-y: auto;">
            <table class="table" id="assignmentTable">
                <thead>
                    <tr>
                            <th>STT</th>
                            <th>Số Bill</th>
                            <th>Ngày bốc</th>
                            <th>Mã khách gửi</th>
                            <th>Tên khách gửi</th>
                            <th>Xã</th>
                            <th>Địa chỉ</th>
                            <th>Địa chỉ đã lưu</th>
                            <th>Tên khách nhận</th>
                            <th>Địa chỉ nhận</th>
                            <th>Tỉnh nhận</th>
                            <th>Xã nhận</th>
                            <th>SĐT khách nhận</th>
                            <th>Dịch vụ GTGT</th>
                            <th>Nội dung hàng hóa</th>
                            <th>Số kiện</th>
                            <th>Trọng lượng thực</th>
                            <th>Thể tích</th>
                            <th>Đơn vị tính cước</th>
                            <th>Đơn giá</th>
                            <th>Phụ phí</th>
                            <th>VAT</th>
                            <th>Thành tiền</th>
                            <th>Người thanh toán</th>
                            <th>COD</th>
                            <th>Trạng thái thanh toán</th>
                        <th>Ghi chú</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody id="assignmentTableBody">
                </tbody>
            </table>
            </div>
        </div>

        <!-- Tab 3: Trạng thái Xe -->
        <div id="status" class="tab-content">
            <h3>Trạng thái các Xe</h3>
            <div id="vehicleStatusList">
            </div>
        </div>

        <!-- Tab 4: Xếp hàng -->
        <div id="unassigned" class="tab-content">
            <h3>Bảng xếp hàng</h3>
            <div style="overflow-x: auto; max-height: 600px; overflow-y: auto;">
            <table class="table" id="unassignedTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Xe</th>
                        <th>NCC</th>
                        <th>Bill</th>
                        <th>Khách hàng</th>
                        <th>Tên mặt hàng</th>
                        <th>Số kiện</th>
                        <th>Tỉnh trả</th>
                        <th>Xã trả</th>
                        <th>Nơi trả</th>
                        <th>Ngày xuất xe</th>
                        <th>Ghi chú</th>
                        <th>STT</th>
                        <th>Ảnh Bill</th>
                        <th>Tổng chi phí</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody id="unassignedTableBody">
                </tbody>
            </table>
            </div>
        </div>
    </div>

    <!-- Modal Thêm/Sửa Xe -->
    <div id="vehicleModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeVehicleModal()">&times;</span>
            <h2 id="vehicleModalTitle">Thêm Xe mới</h2>
            <form id="vehicleForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>ID Xe:</label>
                        <input type="text" id="vehicleId" required>
                    </div>
                    <div class="form-group">
                        <label>Biển kiểm soát:</label>
                        <input type="text" id="vehiclePlate" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Lái xe:</label>
                        <input type="text" id="vehicleDriver" required>
                    </div>
                    <div class="form-group">
                        <label>SBT lái xe:</label>
                        <input type="text" id="vehicleDriverPhone" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Ngày xuất xe:</label>
                        <input type="date" id="vehicleDepartureDate" required>
                    </div>
                    <div class="form-group">
                        <label>Ngày dự kiến:</label>
                        <input type="text" id="vehicleExpectedDate" placeholder="Có thể là mã hoặc ngày">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Mã nhà cung cấp:</label>
                        <select id="vehicleSupplierCode">
                            <option value="">-- Chọn mã nhà cung cấp --</option>
                            <option value="XELE">XELE - Xe lẻ</option>
                            <option value="CHIEN3C">CHIEN3C - Chiến 3 chân</option>
                            <option value="DUNG3C">DUNG3C - Dũng 3 chân</option>
                            <option value="VIETTEL48">VIETTEL48 - Viettel tàu 48h</option>
                            <option value="SONGTR">SONGTR - Song Trường Cont</option>
                            <option value="TINH3C">TINH3C - Tình 3 chân</option>
                            <option value="VIC">VIC - XE VIC</option>
                            <option value="BFY72">BFY72 - BFY Tàu 72h</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tên nhà cung cấp:</label>
                        <input type="text" id="vehicleSupplierName" readonly>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Trạng thái thanh toán:</label>
                        <input type="text" id="vehiclePaymentStatus">
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <div></div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Trạng thái:</label>
                    <select id="vehicleStatus">
                        <option value="pending">Chờ xếp hàng</option>
                        <option value="in-transit">Đang vận chuyển</option>
                        <option value="delivered">Đã giao hàng</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Ghi chú:</label>
                        <textarea id="vehicleNote" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Ghi chú bổ sung:</label>
                        <textarea id="vehicleAdditionalNote" rows="2"></textarea>
                    </div>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-success">Lưu</button>
                    <button type="button" class="btn" onclick="closeVehicleModal()">Hủy</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Phân phối Đơn hàng -->
    <div id="assignmentModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <span class="close" onclick="closeAssignmentModal()">&times;</span>
            <h2>Phân phối Đơn hàng</h2>
            <form id="assignmentForm">
                <!-- Thông tin xe -->
                <div class="form-group">
                    <label>Chọn Xe:</label>
                    <select id="assignmentVehicle" required>
                        <option value="">-- Chọn xe --</option>
                    </select>
                </div>
                
                <!-- Thông tin Bill cơ bản -->
                <div class="form-row">
                <div class="form-group">
                        <label>Số Bill:</label>
                        <input type="text" id="assignmentBillNumber" required>
                    </div>
                    <div class="form-group">
                        <label>Ngày bốc:</label>
                        <input type="date" id="assignmentPickupDate" required>
                    </div>
                </div>
                
                <!-- Thông tin khách gửi -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Mã khách gửi:</label>
                        <input type="text" id="assignmentSenderCode">
                    </div>
                    <div class="form-group">
                        <label>Tên khách gửi:</label>
                        <input type="text" id="assignmentSenderName" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Xã:</label>
                        <input type="text" id="assignmentWard">
                    </div>
                    <div class="form-group">
                        <label>Địa chỉ:</label>
                        <input type="text" id="assignmentAddress">
                    </div>
                </div>
                
                <!-- Thông tin khách nhận -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Tên khách nhận:</label>
                        <input type="text" id="assignmentReceiverName" required>
                    </div>
                    <div class="form-group">
                        <label>Địa chỉ nhận:</label>
                        <input type="text" id="assignmentReceiverAddress" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Tỉnh nhận:</label>
                        <input type="text" id="assignmentReceiverProvince" required>
                    </div>
                    <div class="form-group">
                        <label>Xã nhận:</label>
                        <input type="text" id="assignmentReceiverWard">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>SĐT khách nhận:</label>
                        <input type="text" id="assignmentReceiverPhone">
                    </div>
                    <div class="form-group">
                        <label>Dịch vụ GTGT:</label>
                        <input type="text" id="assignmentService">
                    </div>
                </div>
                
                <!-- Thông tin hàng hóa -->
                <div class="form-group">
                    <label>Nội dung hàng hóa:</label>
                    <textarea id="assignmentContent" rows="2"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Số kiện:</label>
                        <input type="number" id="assignmentPackages" min="1" required>
                    </div>
                    <div class="form-group">
                        <label>Trọng lượng thực:</label>
                        <input type="number" id="assignmentWeight" step="0.1" min="0">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Thể tích:</label>
                        <input type="number" id="assignmentVolume" step="0.1" min="0">
                    </div>
                    <div class="form-group">
                        <label>Đơn vị tính cước:</label>
                        <input type="text" id="assignmentUnit">
                    </div>
                </div>
                
                <!-- Thông tin tài chính -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Đơn giá:</label>
                        <input type="number" id="assignmentUnitPrice" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label>Phụ phí:</label>
                        <input type="number" id="assignmentExtraFee" step="0.01" min="0">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>VAT:</label>
                        <input type="number" id="assignmentVAT" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label>Thành tiền:</label>
                        <input type="number" id="assignmentTotalAmount" step="0.01" min="0" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Người thanh toán:</label>
                        <input type="text" id="assignmentPayer">
                    </div>
                    <div class="form-group">
                        <label>COD:</label>
                        <input type="number" id="assignmentCOD" step="0.01" min="0">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Trạng thái thanh toán:</label>
                    <select id="assignmentPaymentStatus">
                        <option value="Chưa thanh toán">Chưa thanh toán</option>
                        <option value="Đã thanh toán">Đã thanh toán</option>
                        <option value="Công nợ">Công nợ</option>
                    </select>
                </div>
                
                <!-- Thông tin phân phối -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Số thứ tự:</label>
                        <input type="number" id="assignmentOrder" min="1" required>
                    </div>
                    <div class="form-group">
                        <label>Số lượng hàng:</label>
                        <input type="number" id="assignmentQuantity" min="1" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Ghi chú:</label>
                    <textarea id="assignmentNote" rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <button type="submit" class="btn btn-success">Lưu</button>
                    <button type="button" class="btn" onclick="closeAssignmentModal()">Hủy</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Configuration
        const SHEET_ID = '1SbK_vKUJV7dTzDPmxmlEM-7MXBoh6guGRKU4dWvAiw4';
        const VEHICLE_SHEET = 'Xe';
        const BILL_SHEET = 'Bill';
        const ASSIGNMENT_SHEET = 'XepHang';
        const CUSTOMER_SHEET = 'Khách hàng';

        // Data storage
        let vehicles = [];
        let bills = [];
        let assignments = [];
        let customers = [];
        let currentVehicleId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadAllData();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Vehicle form
            document.getElementById('vehicleForm').addEventListener('submit', saveVehicle);
            document.getElementById('vehicleDepartureDate').addEventListener('change', calculateExpectedDate);
            document.getElementById('vehicleSupplierCode').addEventListener('change', updateSupplierName);
            
            // Assignment form
            document.getElementById('assignmentForm').addEventListener('submit', saveAssignment);
        }
        
        function updateSupplierName() {
            const supplierCode = document.getElementById('vehicleSupplierCode').value;
            const supplierNameField = document.getElementById('vehicleSupplierName');
            
            const supplierMap = {
                'XELE': 'Xe lẻ',
                'CHIEN3C': 'Chiến 3 chân',
                'DUNG3C': 'Dũng 3 chân',
                'VIETTEL48': 'Viettel tàu 48h',
                'SONGTR': 'Song Trường Cont',
                'TINH3C': 'Tình 3 chân',
                'VIC': 'XE VIC',
                'BFY72': 'BFY Tàu 72h'
            };
            
            supplierNameField.value = supplierMap[supplierCode] || '';
        }

        function calculateExpectedDate() {
            const departureDate = document.getElementById('vehicleDepartureDate').value;
            if (departureDate) {
                const date = new Date(departureDate);
                date.setDate(date.getDate() + 3);
                document.getElementById('vehicleExpectedDate').value = date.toISOString().split('T')[0];
            }
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Load data for specific tabs
            if (tabName === 'status') {
                loadVehicleStatus();
            } else if (tabName === 'unassigned') {
                loadUnassignedOrders();
            }
        }

        async function loadAllData() {
            try {
                await Promise.all([
                    loadVehicles(),
                    loadBills(),
                    loadAssignments(),
                    loadCustomers()
                ]);
                
                // Load local changes và merge vào data
                const localVehicles = readLocalVehicles();
                const localAssignments = readLocalAssignments();
                const localBills = readLocalBills();
                
                // Merge local vehicles
                localVehicles.forEach(localVehicle => {
                    const existingIndex = vehicles.findIndex(v => String(v.ID).toLowerCase() === String(localVehicle.ID).toLowerCase());
                    if (existingIndex >= 0) {
                        vehicles[existingIndex] = localVehicle;
                    } else {
                        vehicles.push(localVehicle);
                    }
                });
                
                // Merge local assignments
                localAssignments.forEach(localAssignment => {
                    const existingIndex = assignments.findIndex(a => String(a.ID).toLowerCase() === String(localAssignment.ID).toLowerCase());
                    if (existingIndex >= 0) {
                        assignments[existingIndex] = localAssignment;
                    } else {
                        assignments.push(localAssignment);
                    }
                });

                // Merge local bills
                localBills.forEach(localBill => {
                    const existingIndex = bills.findIndex(b => String(b['Số Bill']).toLowerCase() === String(localBill['Số Bill']).toLowerCase());
                    if (existingIndex >= 0) {
                        bills[existingIndex] = localBill;
                    } else {
                        bills.push(localBill);
                    }
                });
                
                // Sắp xếp bills sau khi merge local data
                if (bills.length > 0) {
                    bills.sort((a, b) => {
                        const sttA = parseInt(a['STT']) || 0;
                        const sttB = parseInt(b['STT']) || 0;
                        return sttA - sttB;
                    });
                    console.log('Đã tự động sắp xếp bills sau khi merge local data');
                }
                
                renderAllTables();
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Lỗi tải dữ liệu: ' + error.message);
            }
        }

        async function loadVehicles() {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${VEHICLE_SHEET}&tqx=out:json`;
            const response = await fetch(url);
            const text = await response.text();
            const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
            
            vehicles = [];
            if (json.table && json.table.rows) {
                const headers = json.table.cols.map(c => c.label || '');
                console.log('Headers found:', headers); // Debug log
                
                json.table.rows.forEach((row, index) => {
                    const raw = {};
                    row.c.forEach((cell, i) => {
                        raw[headers[i]] = cell ? cell.v : '';
                    });
                    
                    // Map theo tên cột thực tế trong sheet xe của bạn
                    const vehicle = {
                        ID: raw['ID'] || raw['id'] || raw['D'] || (index + 1),
                        'STT': raw['D'] || raw['STT'] || (index + 1),
                        'Ngày xuất xe': raw['NgayXuat'] || raw['Ngày xuất xe'] || raw['Ngày xuất'],
                        'NgayXuat': raw['NgayXuat'] || raw['Ngày xuất xe'],
                        'Trạng thái': raw['TrangThai'] || raw['Trạng thái'] || 'pending',
                        'TrangThai': raw['TrangThai'] || raw['Trạng thái'],
                        'Ghi chú': raw['GhiChu'] || raw['Ghi chú'],
                        'GhiChu': raw['GhiChu'] || raw['Ghi chú'],
                        'Ngày dự kiến': raw['NgayDuKien'] || raw['Ngày dự kiến'],
                        'NgayDuKien': raw['NgayDuKien'] || raw['Ngày dự kiến'],
                        'Tên nhà cung cấp': raw['Tên nhà cung cấp'] || raw['Ten nha cung cap'],
                        'TenNhaCungCap': raw['Tên nhà cung cấp'] || raw['Ten nha cung cap'],
                        'Mã nhà cung cấp': raw['Mã nhà cung cấp'] || raw['Ma nha cung cap'],
                        'MaNhaCungCap': raw['Mã nhà cung cấp'] || raw['Ma nha cung cap'],
                        'NCC': raw['NCC'] || raw['ncc'],
                        'Trạng thái thanh toán': raw['Trạng thái thanh toán'] || raw['Trang thai thanh toan'],
                        'TrangThaiThanhToan': raw['Trạng thái thanh toán'] || raw['Trang thai thanh toan'],
                        'Biển số': raw['Biển kiểm soát'] || raw['Bien kiem soat'] || raw['Biển số'],
                        'Biển kiểm soát': raw['Biển kiểm soát'] || raw['Bien kiem soat'],
                        'BienKiemSoat': raw['Biển kiểm soát'] || raw['Bien kiem soat'],
                        'Tài xế': raw['Lái xe'] || raw['Lai xe'] || raw['Tài xế'],
                        'Lái xe': raw['Lái xe'] || raw['Lai xe'],
                        'LaiXe': raw['Lái xe'] || raw['Lai xe'],
                        'SĐT Tài xế': raw['SBT lái xe'] || raw['SĐT lái xe'] || raw['SĐT Tài xế'],
                        'SBT lái xe': raw['SBT lái xe'] || raw['SĐT lái xe'],
                        'SBTLaiXe': raw['SBT lái xe'] || raw['SĐT lái xe'],
                        'Ghi chú bổ sung': raw['Ghi chú bổ sung'] || raw['Ghi chu bo sung'],
                        'GhiChuBoSung': raw['Ghi chú bổ sung'] || raw['Ghi chu bo sung']
                    };
                    
                    if (vehicle.ID) {
                        vehicles.push(vehicle);
                        console.log('Loaded vehicle:', vehicle); // Debug log
                    }
                });
            }
            console.log('Total vehicles loaded:', vehicles.length); // Debug log
        }

        async function loadBills() {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${BILL_SHEET}&tqx=out:json`;
            const response = await fetch(url);
            const text = await response.text();
            const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
            
            bills = [];
            if (json.table && json.table.rows) {
                const headers = json.table.cols.map(c => c.label || '');
                console.log('Bill headers found:', headers); // Debug log
                
                json.table.rows.forEach((row, index) => {
                    if (index === 0) return; // Skip header
                    const raw = {};
                    row.c.forEach((cell, i) => {
                        raw[headers[i]] = cell ? cell.v : '';
                    });
                    
                    // Map tất cả các trường từ sheet Bill và bảng xếp hàng
                    const bill = {
                        'ID': raw['ID'] || raw['id'] || raw['Số Bill'],
                        'Xe': raw['Xe'] || raw['xe'],
                        'NCC': raw['NCC'] || raw['ncc'] || raw['Mã khách gửi'],
                        'STT': raw['STT'] || raw['stt'] || (index),
                        'Số Bill': raw['Số Bill'] || raw['So Bill'] || raw['Số bill'],
                        'Ngày bốc': raw['Ngày bốc'] || raw['Ngay boc'],
                        'Ngày xuất xe': raw['Ngày xuất xe'] || raw['Ngay xuat xe'],
                        'Mã khách gửi': raw['Mã khách gửi'] || raw['Ma khach gui'],
                        'Tên khách gửi': raw['Tên khách gửi'] || raw['Ten khach gui'],
                        'Khách hàng': raw['Khách hàng'] || raw['Khach hang'] || raw['Tên khách gửi'],
                        'Xã': raw['Xã'] || raw['Xa'],
                        'Địa chỉ': raw['Địa chỉ'] || raw['Dia chi'],
                        'Địa chỉ đã lưu': raw['Địa chỉ đã lưu'] || raw['Dia chi da luu'],
                        'Tên khách nhận': raw['Tên khách nhận'] || raw['Ten khach nhan'],
                        'Địa chỉ nhận': raw['Địa chỉ nhận'] || raw['Dia chi nhan'],
                        'Tỉnh nhận': raw['Tỉnh nhận'] || raw['Tinh nhan'],
                        'Tỉnh trả': raw['Tỉnh trả'] || raw['Tinh tra'] || raw['Tỉnh nhận'],
                        'Xã nhận': raw['Xã nhận'] || raw['Xa nhan'],
                        'Xã trả': raw['Xã trả'] || raw['Xa tra'] || raw['Xã nhận'],
                        'Nơi trả': raw['Nơi trả'] || raw['Noi tra'] || raw['Địa chỉ nhận'],
                        'SĐT khách nhận': raw['SĐT khách nhận'] || raw['SDT khach nhan'],
                        'Dịch vụ GTGT': raw['Dịch vụ GTGT'] || raw['Dich vu GTGT'],
                        'Nội dung hàng hóa': raw['Nội dung hàng hóa'] || raw['Noi dung hang hoa'],
                        'Tên mặt hàng': raw['Tên mặt hàng'] || raw['Ten mat hang'] || raw['Nội dung hàng hóa'],
                        'Số kiện': raw['Số kiện'] || raw['So kien'],
                        'Trọng lượng thực': raw['Trọng lượng thực'] || raw['Trong luong thuc'],
                        'Thể tích': raw['Thể tích'] || raw['The tich'],
                        'Đơn vị tính cước': raw['Đơn vị tính cước'] || raw['Don vi tinh cuoc'],
                        'Đơn giá': raw['Đơn giá'] || raw['Don gia'],
                        'Phụ phí': raw['Phụ phí'] || raw['Phu phi'],
                        'VAT': raw['VAT'] || raw['vat'],
                        'Thành tiền': raw['Thành tiền'] || raw['Thanh tien'],
                        'Tổng chi phí': raw['Tổng chi phí'] || raw['Tong chi phi'] || raw['Thành tiền'],
                        'Người thanh toán': raw['Người thanh toán'] || raw['Nguoi thanh toan'],
                        'COD': raw['COD'] || raw['cod'],
                        'Trạng thái thanh toán': raw['Trạng thái thanh toán'] || raw['Trang thai thanh toan'],
                        'Ghi chú': raw['Ghi chú'] || raw['Ghi chu'],
                        'Ảnh Bill': raw['Ảnh Bill'] || raw['Anh Bill'] || raw['anh bill']
                    };
                    
                    if (bill['Số Bill']) {
                        bills.push(bill);
                        console.log('Loaded bill:', bill); // Debug log
                    }
                });
            }
            console.log('Total bills loaded:', bills.length); // Debug log
            
            // Tự động sắp xếp bills theo STT sau khi load
            if (bills.length > 0) {
                bills.sort((a, b) => {
                    const sttA = parseInt(a['STT']) || 0;
                    const sttB = parseInt(b['STT']) || 0;
                    return sttA - sttB;
                });
                console.log('Đã tự động sắp xếp bills theo STT sau khi load từ Google Sheet');
            }
        }

        async function loadAssignments() {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${ASSIGNMENT_SHEET}&tqx=out:json`;
            const response = await fetch(url);
            const text = await response.text();
            const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
            
            assignments = [];
            if (json.table && json.table.rows) {
                const headers = json.table.cols.map(c => c.label || '');
                json.table.rows.forEach((row, index) => {
                    if (index === 0) return; // Skip header
                    const assignment = {};
                    row.c.forEach((cell, i) => {
                        assignment[headers[i]] = cell ? cell.v : '';
                    });
                    if (assignment.ID) assignments.push(assignment);
                });
            }
        }

        async function loadCustomers() {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${CUSTOMER_SHEET}&tqx=out:json`;
            const response = await fetch(url);
            const text = await response.text();
            const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
            
            customers = [];
            if (json.table && json.table.rows) {
                const headers = json.table.cols.map(c => c.label || '');
                json.table.rows.forEach((row, index) => {
                    if (index === 0) return; // Skip header
                    const customer = {};
                    row.c.forEach((cell, i) => {
                        customer[headers[i]] = cell ? cell.v : '';
                    });
                    if (customer.ID) customers.push(customer);
                });
            }
        }

        function renderAllTables() {
            // Tự động sắp xếp bills theo STT khi load
            if (bills.length > 0) {
                bills.sort((a, b) => {
                    const sttA = parseInt(a['STT']) || 0;
                    const sttB = parseInt(b['STT']) || 0;
                    return sttA - sttB;
                });
                console.log('Đã tự động sắp xếp bills theo STT khi load');
            }
            
            renderVehicleTable();
            renderAssignmentTable();
            loadVehicleStatus();
            loadUnassignedOrders();
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                // Xử lý định dạng Date(YYYY,M,D)
                if (typeof dateString === 'string' && dateString.startsWith('Date(')) {
                    const match = dateString.match(/Date\((\d+),(\d+),(\d+)\)/);
                    if (match) {
                        const year = parseInt(match[1]);
                        const month = parseInt(match[2]) + 1; // Month is 0-indexed in Date()
                        const day = parseInt(match[3]);
                        const date = new Date(year, month - 1, day);
                        return date.toISOString().split('T')[0]; // YYYY-MM-DD format
                    }
                }
                
                // Xử lý định dạng thông thường
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString;
                return date.toISOString().split('T')[0]; // YYYY-MM-DD format
            } catch (error) {
                return dateString;
            }
        }

        function renderVehicleTable() {
            const tbody = document.getElementById('vehicleTableBody');
            tbody.innerHTML = '';
            
            vehicles.forEach((vehicle, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${formatDate(vehicle['Ngày xuất xe'] || vehicle['NgayXuat'])}</td>
                    <td><span class="status-badge status-${vehicle['Trạng thái'] || vehicle['TrangThai'] || 'pending'}">${getStatusText(vehicle['Trạng thái'] || vehicle['TrangThai'])}</span></td>
                    <td>${vehicle['Ghi chú'] || vehicle['GhiChu'] || ''}</td>
                    <td>${formatDate(vehicle['Ngày dự kiến'] || vehicle['NgayDuKien']) || vehicle['NgayDuKien'] || ''}</td>
                    <td>${vehicle['Tên nhà cung cấp'] || vehicle['TenNhaCungCap'] || ''}</td>
                    <td>${vehicle['Trạng thái thanh toán'] || vehicle['TrangThaiThanhToan'] || ''}</td>
                    <td>${vehicle['Biển số'] || vehicle['Biển kiểm soát'] || vehicle['BienKiemSoat'] || ''}</td>
                    <td>${vehicle['Tài xế'] || vehicle['Lái xe'] || vehicle['LaiXe'] || ''}</td>
                    <td>${vehicle['SĐT Tài xế'] || vehicle['SBT lái xe'] || vehicle['SBTLaiXe'] || ''}</td>
                    <td>${vehicle['Ghi chú bổ sung'] || vehicle['GhiChuBoSung'] || ''}</td>
                    <td>
                        <button class="btn" onclick="editVehicle('${vehicle.ID}')">Sửa</button>
                        <button class="btn btn-danger" onclick="deleteVehicle('${vehicle.ID}')">Xóa</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderAssignmentTable() {
            const tbody = document.getElementById('assignmentTableBody');
            tbody.innerHTML = '';
            
            // Hiển thị dữ liệu từ sheet Bill
            bills.forEach((bill, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <input type="number" 
                               value="${bill['STT'] || (index + 1)}" 
                               min="1" 
                               style="width: 60px; padding: 4px; border: 1px solid #ddd; border-radius: 3px;"
                               onchange="updateBillSTT('${bill['Số Bill']}', this.value)"
                               onblur="updateBillSTT('${bill['Số Bill']}', this.value)">
                    </td>
                    <td>${bill['Số Bill'] || ''}</td>
                    <td>${formatDate(bill['Ngày bốc']) || ''}</td>
                    <td>${bill['Mã khách gửi'] || ''}</td>
                    <td>${bill['Tên khách gửi'] || ''}</td>
                    <td>${bill['Xã'] || ''}</td>
                    <td>${bill['Địa chỉ'] || ''}</td>
                    <td>${bill['Địa chỉ đã lưu'] || ''}</td>
                    <td>${bill['Tên khách nhận'] || ''}</td>
                    <td>${bill['Địa chỉ nhận'] || ''}</td>
                    <td>${bill['Tỉnh nhận'] || ''}</td>
                    <td>${bill['Xã nhận'] || ''}</td>
                    <td>${bill['SĐT khách nhận'] || ''}</td>
                    <td>${bill['Dịch vụ GTGT'] || ''}</td>
                    <td>${bill['Nội dung hàng hóa'] || ''}</td>
                    <td>${bill['Số kiện'] || ''}</td>
                    <td>${bill['Trọng lượng thực'] || ''}</td>
                    <td>${bill['Thể tích'] || ''}</td>
                    <td>${bill['Đơn vị tính cước'] || ''}</td>
                    <td>${bill['Đơn giá'] || ''}</td>
                    <td>${bill['Phụ phí'] || ''}</td>
                    <td>${bill['VAT'] || ''}</td>
                    <td>${bill['Thành tiền'] || ''}</td>
                    <td>${bill['Người thanh toán'] || ''}</td>
                    <td>${bill['COD'] || ''}</td>
                    <td>${bill['Trạng thái thanh toán'] || ''}</td>
                    <td>${bill['Ghi chú'] || ''}</td>
                    <td>
                        <button class="btn" onclick="editBill('${bill['Số Bill']}')">Sửa</button>
                        <button class="btn btn-danger" onclick="deleteBill('${bill['Số Bill']}')">Xóa</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadVehicleStatus() {
            const container = document.getElementById('vehicleStatusList');
            container.innerHTML = '';
            
            vehicles.forEach(vehicle => {
                const vehicleAssignments = assignments.filter(a => a['Xe'] === vehicle.ID);
                const div = document.createElement('div');
                div.style.cssText = 'border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 5px;';
                div.innerHTML = `
                    <h4>Xe ${vehicle['Biển số']} - ${vehicle['Tài xế']} <span class="status-badge status-${vehicle['Trạng thái'] || 'pending'}">${getStatusText(vehicle['Trạng thái'])}</span></h4>
                    <p><strong>Ngày xuất xe:</strong> ${formatDate(vehicle['Ngày xuất xe'])}</p>
                    <p><strong>Ngày dự kiến:</strong> ${formatDate(vehicle['Ngày dự kiến'])}</p>
                    <h5>Đơn hàng đã xếp:</h5>
                    <ul>
                        ${vehicleAssignments.map(a => {
                            const bill = bills.find(b => b.ID === a['Bill']);
                            return `<li>${bill ? bill['Tên đơn hàng'] : a['Bill']} - Số lượng: ${a['Số lượng hàng']}</li>`;
                        }).join('')}
                    </ul>
                `;
                container.appendChild(div);
            });
        }

        function loadUnassignedOrders() {
            const tbody = document.getElementById('unassignedTableBody');
            tbody.innerHTML = '';
            
            // Hiển thị tất cả bills từ bảng xếp hàng với đầy đủ thông tin
            bills.forEach((bill, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${bill['ID'] || bill['Số Bill'] || ''}</td>
                    <td>${bill['Xe'] || ''}</td>
                    <td>${bill['NCC'] || bill['Mã khách gửi'] || ''}</td>
                    <td>${bill['Số Bill'] || ''}</td>
                    <td>${bill['Khách hàng'] || bill['Tên khách gửi'] || ''}</td>
                    <td>${bill['Tên mặt hàng'] || bill['Nội dung hàng hóa'] || ''}</td>
                    <td>${bill['Số kiện'] || ''}</td>
                    <td>${bill['Tỉnh trả'] || bill['Tỉnh nhận'] || ''}</td>
                    <td>${bill['Xã trả'] || bill['Xã nhận'] || ''}</td>
                    <td>${bill['Nơi trả'] || bill['Địa chỉ nhận'] || ''}</td>
                    <td>${formatDate(bill['Ngày xuất xe']) || formatDate(bill['Ngày bốc']) || ''}</td>
                    <td>${bill['Ghi chú'] || ''}</td>
                    <td>${bill['STT'] || (index + 1)}</td>
                    <td>${bill['Ảnh Bill'] || ''}</td>
                    <td>${bill['Tổng chi phí'] || bill['Thành tiền'] || ''}</td>
                    <td>
                        <button class="btn btn-success" onclick="assignBill('${bill['Số Bill']}')">Xếp hàng</button>
                        <button class="btn" onclick="editBill('${bill['Số Bill']}')">Sửa</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'Chờ xếp hàng',
                'in-transit': 'Đang vận chuyển',
                'delivered': 'Đã giao hàng'
            };
            return statusMap[status] || 'Chờ xếp hàng';
        }

        function showVehicleModal(vehicleId = null) {
            currentVehicleId = vehicleId;
            const modal = document.getElementById('vehicleModal');
            const title = document.getElementById('vehicleModalTitle');
            const form = document.getElementById('vehicleForm');
            
            if (vehicleId) {
                title.textContent = 'Sửa Xe';
                const vehicle = vehicles.find(v => v.ID === vehicleId);
                if (vehicle) {
                    document.getElementById('vehicleId').value = vehicle.ID || '';
                    document.getElementById('vehiclePlate').value = vehicle['Biển số'] || vehicle['Biển kiểm soát'] || '';
                    document.getElementById('vehicleDriver').value = vehicle['Tài xế'] || vehicle['Lái xe'] || '';
                    document.getElementById('vehicleDriverPhone').value = vehicle['SĐT Tài xế'] || vehicle['SBT lái xe'] || '';
                    document.getElementById('vehicleDepartureDate').value = formatDate(vehicle['Ngày xuất xe'] || vehicle['NgayXuat']) || '';
                    document.getElementById('vehicleExpectedDate').value = vehicle['Ngày dự kiến'] || vehicle['NgayDuKien'] || '';
                    // Tìm mã nhà cung cấp từ tên hoặc mã
                    const supplierName = vehicle['Tên nhà cung cấp'] || vehicle['TenNhaCungCap'] || '';
                    const supplierCode = vehicle['Mã nhà cung cấp'] || vehicle['MaNhaCungCap'] || vehicle['NCC'] || '';
                    
                    // Tìm mã từ tên nếu có
                    const supplierMap = {
                        'Xe lẻ': 'XELE',
                        'Chiến 3 chân': 'CHIEN3C',
                        'Dũng 3 chân': 'DUNG3C',
                        'Viettel tàu 48h': 'VIETTEL48',
                        'Song Trường Cont': 'SONGTR',
                        'Tình 3 chân': 'TINH3C',
                        'XE VIC': 'VIC',
                        'BFY Tàu 72h': 'BFY72'
                    };
                    
                    const foundCode = supplierCode || supplierMap[supplierName] || '';
                    document.getElementById('vehicleSupplierCode').value = foundCode;
                    document.getElementById('vehicleSupplierName').value = supplierName;
                    document.getElementById('vehiclePaymentStatus').value = vehicle['Trạng thái thanh toán'] || vehicle['TrangThaiThanhToan'] || '';
                    document.getElementById('vehicleStatus').value = vehicle['Trạng thái'] || vehicle['TrangThai'] || 'pending';
                    document.getElementById('vehicleNote').value = vehicle['Ghi chú'] || vehicle['GhiChu'] || '';
                    document.getElementById('vehicleAdditionalNote').value = vehicle['Ghi chú bổ sung'] || vehicle['GhiChuBoSung'] || '';
                }
            } else {
                title.textContent = 'Thêm Xe mới';
                form.reset();
            }
            
            modal.style.display = 'block';
        }

        function closeVehicleModal() {
            document.getElementById('vehicleModal').style.display = 'none';
            currentVehicleId = null;
        }

        function showAssignmentModal(assignmentId = null) {
            const modal = document.getElementById('assignmentModal');
            const vehicleSelect = document.getElementById('assignmentVehicle');
            
            // Populate vehicle options
            vehicleSelect.innerHTML = '<option value="">-- Chọn xe --</option>';
            vehicles.forEach(vehicle => {
                const option = document.createElement('option');
                option.value = vehicle.ID;
                option.textContent = `${vehicle['Biển số']} - ${vehicle['Tài xế']}`;
                vehicleSelect.appendChild(option);
            });
            
            // Reset form
            document.getElementById('assignmentForm').reset();
            
            // Set default values
            document.getElementById('assignmentPickupDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('assignmentPaymentStatus').value = 'Công nợ';
            document.getElementById('assignmentOrder').value = 1;
            document.getElementById('assignmentQuantity').value = 1;
            document.getElementById('assignmentPackages').value = 1;
            
            modal.style.display = 'block';
        }

        function closeAssignmentModal() {
            document.getElementById('assignmentModal').style.display = 'none';
        }

        function assignBill(billId) {
            showAssignmentModal();
            document.getElementById('assignmentBill').value = billId;
        }

        function filterVehicles() {
            const searchTerm = document.getElementById('vehicleSearch').value.toLowerCase();
            const filterDate = document.getElementById('filterVehicleDate').value;
            const filterSupplier = document.getElementById('filterVehicleSupplier').value;
            const filterStatus = document.getElementById('filterVehicleStatus').value;
            const rows = document.querySelectorAll('#vehicleTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const cells = row.querySelectorAll('td');
                
                // Kiểm tra tìm kiếm text
                let matchesSearch = !searchTerm || text.includes(searchTerm);
                
                // Kiểm tra lọc theo ngày
                let matchesDate = true;
                if (filterDate && cells.length > 4) {
                    const dateCell = cells[4].textContent.trim();
                    const cellDate = formatDate(dateCell);
                    matchesDate = cellDate === filterDate;
                }
                
                // Kiểm tra lọc theo tên nhà cung cấp
                let matchesSupplier = true;
                if (filterSupplier) {
                    // Lấy tên nhà cung cấp từ mã được chọn
                    const supplierNameMap = {
                        'XELE': 'Xe lẻ',
                        'CHIEN3C': 'Chiến 3 chân',
                        'DUNG3C': 'Dũng 3 chân',
                        'VIETTEL48': 'Viettel tàu 48h',
                        'SONGTR': 'Song Trường Cont',
                        'TINH3C': 'Tình 3 chân',
                        'VIC': 'XE VIC',
                        'BFY72': 'BFY Tàu 72h'
                    };
                    
                    const targetSupplierName = supplierNameMap[filterSupplier];
                    if (!targetSupplierName) {
                        matchesSupplier = true;
                    } else {
                        // Tìm xe có tên nhà cung cấp tương ứng
                        // Lấy STT từ cột đầu tiên để tìm xe tương ứng
                        const stt = parseInt(cells[0].textContent.trim());
                        const vehicle = vehicles[stt - 1]; // STT bắt đầu từ 1, array bắt đầu từ 0
                        
                        // Kiểm tra trong dữ liệu xe trực tiếp
                        let hasSupplier = false;
                        if (vehicle) {
                            console.log('Checking vehicle:', vehicle);
                            console.log('Target supplier name:', targetSupplierName);
                            
                            // Kiểm tra các trường có thể chứa tên nhà cung cấp
                            const vehicleSupplierFields = [
                                vehicle['Tên nhà cung cấp'],
                                vehicle['TenNhaCungCap'],
                                vehicle['NCC'],
                                vehicle['Mã nhà cung cấp'],
                                vehicle['MaNhaCungCap']
                            ];
                            
                            console.log('Vehicle supplier fields:', vehicleSupplierFields);
                            
                            hasSupplier = vehicleSupplierFields.some(field => {
                                if (!field) return false;
                                const fieldStr = String(field).toLowerCase();
                                const matches = fieldStr.includes(targetSupplierName.toLowerCase()) || 
                                              fieldStr === targetSupplierName.toLowerCase();
                                console.log(`Field "${field}" matches "${targetSupplierName}": ${matches}`);
                                return matches;
                            });
                            
                            console.log('Has supplier in vehicle:', hasSupplier);
                        }
                        
                        // Nếu không tìm thấy trong xe, tìm trong assignments và bills
                        if (!hasSupplier && vehicle) {
                            const vehicleAssignments = assignments.filter(a => a['Xe'] === vehicle.ID);
                            hasSupplier = vehicleAssignments.some(a => {
                                const bill = bills.find(b => b['Số Bill'] === a['Số Bill']);
                                if (bill) {
                                    const billSupplierFields = [
                                        bill['NCC'],
                                        bill['Mã khách gửi'],
                                        bill['Mã nhà cung cấp'],
                                        bill['MaNhaCungCap'],
                                        bill['Tên khách gửi']
                                    ];
                                    return billSupplierFields.some(field => {
                                        if (!field) return false;
                                        const fieldStr = String(field).toLowerCase();
                                        return fieldStr.includes(targetSupplierName.toLowerCase()) || 
                                               fieldStr === targetSupplierName.toLowerCase();
                                    });
                                }
                                return false;
                            });
                        }
                        
                        matchesSupplier = hasSupplier;
                    }
                }
                
                // Kiểm tra lọc theo trạng thái
                let matchesStatus = true;
                if (filterStatus && cells.length > 6) {
                    const statusCell = cells[6].textContent.toLowerCase();
                    const statusMap = {
                        'pending': 'chờ xếp hàng',
                        'in-transit': 'đang vận chuyển',
                        'delivered': 'đã giao hàng'
                    };
                    matchesStatus = statusCell.includes(statusMap[filterStatus] || '');
                }
                
                // Hiển thị nếu tất cả điều kiện đều thỏa mãn
                row.style.display = (matchesSearch && matchesDate && matchesSupplier && matchesStatus) ? '' : 'none';
            });
        }
        
        function clearVehicleFilters() {
            document.getElementById('filterVehicleDate').value = '';
            document.getElementById('filterVehicleSupplier').value = '';
            document.getElementById('filterVehicleStatus').value = '';
            document.getElementById('vehicleSearch').value = '';
            filterVehicles();
        }

        // Local storage fallback (giống index.html)
        const LS_KEY_VEHICLES = 'goixe_vehicles_v1';
        const LS_KEY_ASSIGNMENTS = 'goixe_assignments_v1';
        
        function readLocalVehicles() {
            try { return JSON.parse(localStorage.getItem(LS_KEY_VEHICLES) || '[]'); } catch { return []; }
        }
        function writeLocalVehicles(data) {
            localStorage.setItem(LS_KEY_VEHICLES, JSON.stringify(data));
        }
        function readLocalAssignments() {
            try { return JSON.parse(localStorage.getItem(LS_KEY_ASSIGNMENTS) || '[]'); } catch { return []; }
        }
        function writeLocalAssignments(data) {
            localStorage.setItem(LS_KEY_ASSIGNMENTS, JSON.stringify(data));
        }
        
        function upsertLocalVehicle(vehicle) {
            const arr = readLocalVehicles();
            const idx = arr.findIndex(x => String(x.ID).toLowerCase() === String(vehicle.ID).toLowerCase());
            if (idx >= 0) arr[idx] = vehicle; else arr.push(vehicle);
            writeLocalVehicles(arr);
        }
        
        function removeLocalVehicle(id) {
            const arr = readLocalVehicles().filter(x => String(x.ID).toLowerCase() !== String(id).toLowerCase());
            writeLocalVehicles(arr);
        }

        async function saveVehicle(event) {
            event.preventDefault();
            
            const vehicleData = {
                ID: document.getElementById('vehicleId').value,
                'Biển kiểm soát': document.getElementById('vehiclePlate').value,
                'Lái xe': document.getElementById('vehicleDriver').value,
                'SBT lái xe': document.getElementById('vehicleDriverPhone').value,
                'NgayXuat': document.getElementById('vehicleDepartureDate').value,
                'NgayDuKien': document.getElementById('vehicleExpectedDate').value,
                'TrangThai': document.getElementById('vehicleStatus').value,
                'GhiChu': document.getElementById('vehicleNote')?.value || '',
                'Mã nhà cung cấp': document.getElementById('vehicleSupplierCode').value,
                'Tên nhà cung cấp': document.getElementById('vehicleSupplierName').value,
                'NCC': document.getElementById('vehicleSupplierCode').value,
                'Trạng thái thanh toán': document.getElementById('vehiclePaymentStatus').value,
                'Ghi chú bổ sung': document.getElementById('vehicleAdditionalNote').value
            };
            
            // Cập nhật local data trước
            if (currentVehicleId) {
                const index = vehicles.findIndex(v => v.ID === currentVehicleId);
                if (index !== -1) {
                    vehicles[index] = vehicleData;
                }
            } else {
                vehicles.push(vehicleData);
            }
            
            try {
                // Thử gửi lên API để lưu vào Google Sheet
                const response = await fetch('/api/report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'update',
                        sheetId: SHEET_ID,
                        sheetName: VEHICLE_SHEET,
                        data: vehicleData
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Lỗi lưu vào sheet');
                }
                
                // Thành công: lưu vào localStorage làm backup
                upsertLocalVehicle(vehicleData);
                renderVehicleTable();
                closeVehicleModal();
                alert('Đã lưu xe vào Google Sheet thành công!');
                
            } catch (error) {
                console.error('Error saving vehicle:', error);
                // Fallback: chỉ lưu local
                upsertLocalVehicle(vehicleData);
                renderVehicleTable();
                closeVehicleModal();
                alert('Đã lưu xe tạm trên trình duyệt (chưa ghi vào Sheet). Lỗi: ' + error.message);
            }
        }

        function upsertLocalAssignment(assignment) {
            const arr = readLocalAssignments();
            const idx = arr.findIndex(x => String(x.ID).toLowerCase() === String(assignment.ID).toLowerCase());
            if (idx >= 0) arr[idx] = assignment; else arr.push(assignment);
            writeLocalAssignments(arr);
        }

        async function saveAssignment(event) {
            event.preventDefault();
            
            const assignmentData = {
                ID: 'ASS' + Date.now(),
                'Xe': document.getElementById('assignmentVehicle').value,
                'Số Bill': document.getElementById('assignmentBillNumber').value,
                'Ngày bốc': document.getElementById('assignmentPickupDate').value,
                'Mã khách gửi': document.getElementById('assignmentSenderCode').value,
                'Tên khách gửi': document.getElementById('assignmentSenderName').value,
                'Xã': document.getElementById('assignmentWard').value,
                'Địa chỉ': document.getElementById('assignmentAddress').value,
                'Tên khách nhận': document.getElementById('assignmentReceiverName').value,
                'Địa chỉ nhận': document.getElementById('assignmentReceiverAddress').value,
                'Tỉnh nhận': document.getElementById('assignmentReceiverProvince').value,
                'Xã nhận': document.getElementById('assignmentReceiverWard').value,
                'SĐT khách nhận': document.getElementById('assignmentReceiverPhone').value,
                'Dịch vụ GTGT': document.getElementById('assignmentService').value,
                'Nội dung hàng hóa': document.getElementById('assignmentContent').value,
                'Số kiện': document.getElementById('assignmentPackages').value,
                'Trọng lượng thực': document.getElementById('assignmentWeight').value,
                'Thể tích': document.getElementById('assignmentVolume').value,
                'Đơn vị tính cước': document.getElementById('assignmentUnit').value,
                'Đơn giá': document.getElementById('assignmentUnitPrice').value,
                'Phụ phí': document.getElementById('assignmentExtraFee').value,
                'VAT': document.getElementById('assignmentVAT').value,
                'Thành tiền': document.getElementById('assignmentTotalAmount').value,
                'Người thanh toán': document.getElementById('assignmentPayer').value,
                'COD': document.getElementById('assignmentCOD').value,
                'Trạng thái thanh toán': document.getElementById('assignmentPaymentStatus').value,
                'Số thứ tự': document.getElementById('assignmentOrder').value,
                'Số lượng hàng': document.getElementById('assignmentQuantity').value,
                'Ghi chú': document.getElementById('assignmentNote').value
            };
            
            // Cập nhật local data trước
            assignments.push(assignmentData);
            
            try {
                // Thử gửi lên API để lưu vào Google Sheet
                const response = await fetch('/api/report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'update',
                        sheetId: SHEET_ID,
                        sheetName: ASSIGNMENT_SHEET,
                        data: assignmentData
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Lỗi lưu phân phối vào sheet');
                }
                
                // Thành công: lưu vào localStorage làm backup
                upsertLocalAssignment(assignmentData);
                renderAssignmentTable();
                loadUnassignedOrders();
                closeAssignmentModal();
                alert('Đã phân phối đơn hàng vào Google Sheet thành công!');
                
            } catch (error) {
                console.error('Error saving assignment:', error);
                // Fallback: chỉ lưu local
                upsertLocalAssignment(assignmentData);
                renderAssignmentTable();
                loadUnassignedOrders();
                closeAssignmentModal();
                alert('Đã phân phối đơn hàng tạm trên trình duyệt (chưa ghi vào Sheet). Lỗi: ' + error.message);
            }
        }

        function editVehicle(vehicleId) {
            showVehicleModal(vehicleId);
        }

        async function deleteVehicle(vehicleId) {
            if (confirm('Bạn có chắc muốn xóa xe này?')) {
                // Cập nhật local data trước
                vehicles = vehicles.filter(v => v.ID !== vehicleId);
                assignments = assignments.filter(a => a['Xe'] !== vehicleId);
                
                try {
                    // Thử gửi lên API để xóa khỏi Google Sheet
                    const response = await fetch('/api/report', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'delete',
                            sheetId: SHEET_ID,
                            sheetName: VEHICLE_SHEET,
                            id: vehicleId
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Lỗi xóa khỏi sheet');
                    }
                    
                    // Thành công: xóa khỏi localStorage
                    removeLocalVehicle(vehicleId);
                    renderAllTables();
                    alert('Đã xóa xe khỏi Google Sheet thành công!');
                    
                } catch (error) {
                    console.error('Error deleting vehicle:', error);
                    // Fallback: chỉ xóa local
                    removeLocalVehicle(vehicleId);
                    renderAllTables();
                    alert('Đã xóa xe tạm trên trình duyệt (chưa xóa khỏi Sheet). Lỗi: ' + error.message);
                }
            }
        }

        function editAssignment(assignmentId) {
            // Implementation for editing assignment
            alert('Chức năng sửa phân phối đang được phát triển');
        }

        function updateAssignmentOrder(assignmentId, newOrder) {
            const assignment = assignments.find(a => a.ID === assignmentId);
            if (assignment) {
                assignment['Số thứ tự'] = parseInt(newOrder) || 1;
                
                // Cập nhật local storage
                upsertLocalAssignment(assignment);
                
                // Tự động sắp xếp lại table
                renderAssignmentTable();
                
                console.log(`Updated assignment ${assignmentId} order to ${newOrder}`);
            }
        }

        function updateBillSTT(billNumber, newSTT) {
            console.log(`=== UPDATE BILL STT ===`);
            console.log(`Bill Number: "${billNumber}"`);
            console.log(`New STT: "${newSTT}"`);
            console.log(`Current bills count: ${bills.length}`);
            
            const bill = bills.find(b => b['Số Bill'] === billNumber);
            console.log(`Found bill:`, bill);
            
            if (bill) {
                const oldSTT = bill['STT'];
                bill['STT'] = parseInt(newSTT) || 1;
                console.log(`STT changed from ${oldSTT} to ${bill['STT']}`);
                
                // Cập nhật local storage
                upsertLocalBill(bill);
                console.log('Updated local storage');
                
                // Cập nhật vào Google Sheet (không cần render lại table)
                updateBillSTTInSheet(bill);
                
                console.log(`Successfully updated bill ${billNumber} STT to ${newSTT}`);
            } else {
                console.error(`Bill not found: ${billNumber}`);
                console.log('Available bills:', bills.map(b => b['Số Bill']));
            }
            console.log(`=== END UPDATE BILL STT ===`);
        }

        async function updateBillSTTInSheet(bill) {
            try {
                const response = await fetch('/api/report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'updateBillSTT',
                        sheetId: SHEET_ID,
                        sheetName: BILL_SHEET,
                        billNumber: bill['Số Bill'],
                        stt: bill['STT']
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Lỗi cập nhật STT vào sheet');
                }
                
                console.log('STT updated in sheet successfully');
            } catch (error) {
                console.error('Error updating STT in sheet:', error);
                // Không hiển thị lỗi cho user để không làm gián đoạn workflow
            }
        }

        async function sortBillsBySTT() {
            try {
                console.log('Bắt đầu sắp xếp STT...');
                console.log('Tổng số bills trước khi sắp xếp:', bills.length);
                
                // Lấy STT từ input fields trong UI
                const inputFields = document.querySelectorAll('#assignmentTableBody input[type="number"]');
                console.log('Found input fields:', inputFields.length);
                
                // Cập nhật STT từ input fields vào bills array
                bills.forEach((bill, index) => {
                    if (inputFields[index]) {
                        const newSTT = parseInt(inputFields[index].value) || (index + 1);
                        bill['STT'] = newSTT;
                        console.log(`Bill ${bill['Số Bill']}: STT từ input = ${newSTT}`);
                    }
                });
                
                // Sắp xếp bills theo STT từ input fields (giữ nguyên STT người dùng chỉnh)
            bills.sort((a, b) => {
                const sttA = parseInt(a['STT']) || 0;
                const sttB = parseInt(b['STT']) || 0;
                return sttA - sttB;
            });
            
                // Lưu STT đã sắp xếp vào local storage (không thay đổi STT)
                bills.forEach((bill) => {
                upsertLocalBill(bill);
            });
                
                console.log('Đã cập nhật STT local, đang gửi lên Google Sheet...');
                console.log('Bills sau khi sắp xếp:', bills.map(b => ({ 'Số Bill': b['Số Bill'], 'STT': b['STT'] })));
            
            // Cập nhật tất cả STT vào sheet
                const result = await updateAllSTTInSheet();
            
            // Render lại table
            renderAssignmentTable();
            
                if (result && result.success) {
                    alert(`Đã sắp xếp theo STT tùy chỉnh thành công!\nCập nhật: ${result.updated}/${bills.length} items\n\nThứ tự hiện tại: ${bills.map(b => b['STT']).join(', ')}`);
                } else {
                    alert(`Đã sắp xếp theo STT tùy chỉnh và lưu tạm trên trình duyệt.\nCập nhật Sheet: ${result ? result.updated : 0}/${bills.length} items\n\nThứ tự hiện tại: ${bills.map(b => b['STT']).join(', ')}\n\nVui lòng kiểm tra kết nối API.`);
                }
                
            } catch (error) {
                console.error('Error in sortBillsBySTT:', error);
                alert('Lỗi khi sắp xếp STT: ' + error.message);
            }
        }

        async function updateAllSTTInSheet() {
            try {
                console.log('Đang cập nhật STT lên Google Sheet...');
                console.log('SHEET_ID:', SHEET_ID);
                console.log('BILL_SHEET:', BILL_SHEET);
                console.log('Bills to update:', bills.length);
                console.log('Bills data:', bills.map(b => ({ 'Số Bill': b['Số Bill'], 'STT': b['STT'] })));
                
                const response = await fetch('/api/report', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'updateAllSTT',
                        sheetId: SHEET_ID,
                        sheetName: BILL_SHEET,
                        bills: bills
                    })
                });
                
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error Response:', errorText);
                    throw new Error(`Lỗi API: ${response.status} - ${errorText}`);
                }
                
                const result = await response.json();
                console.log('API Success Response:', result);
                
                if (result.ok) {
                console.log('All STT updated in sheet successfully');
                    return {
                        success: true,
                        updated: result.updated || bills.length,
                        total: bills.length,
                        message: result.message || 'Cập nhật thành công'
                    };
                } else {
                    throw new Error(result.error || 'Lỗi không xác định từ API');
                }
                
            } catch (error) {
                console.error('Error updating all STT in sheet:', error);
                
                // Fallback: Lưu vào localStorage
                bills.forEach(bill => {
                    upsertLocalBill(bill);
                });
                
                return {
                    success: false,
                    updated: 0,
                    total: bills.length,
                    error: error.message
                };
            }
        }

        function upsertLocalBill(bill) {
            const arr = readLocalBills();
            const idx = arr.findIndex(x => String(x['Số Bill']).toLowerCase() === String(bill['Số Bill']).toLowerCase());
            if (idx >= 0) arr[idx] = bill; else arr.push(bill);
            writeLocalBills(arr);
        }

        // Function để debug và kiểm tra bills
        function debugBills() {
            console.log('=== DEBUG BILLS ===');
            console.log('Tổng số bills:', bills.length);
            console.log('Bills details:');
            bills.forEach((bill, index) => {
                console.log(`${index + 1}. Số Bill: "${bill['Số Bill']}", STT: ${bill['STT']}`);
            });
            
            // Kiểm tra bills có STT trùng lặp
            const sttCounts = {};
            bills.forEach(bill => {
                const stt = bill['STT'];
                sttCounts[stt] = (sttCounts[stt] || 0) + 1;
            });
            
            const duplicates = Object.entries(sttCounts).filter(([stt, count]) => count > 1);
            if (duplicates.length > 0) {
                console.warn('STT trùng lặp:', duplicates);
            }
            
            // Kiểm tra bills có Số Bill trống
            const emptyBills = bills.filter(bill => {
                const soBill = bill['Số Bill'];
                return !soBill || 
                       (typeof soBill === 'string' && soBill.trim() === '') ||
                       (typeof soBill !== 'string' && typeof soBill !== 'number');
            });
            if (emptyBills.length > 0) {
                console.warn('Bills có Số Bill trống hoặc không hợp lệ:', emptyBills.length);
                console.warn('Chi tiết bills lỗi:', emptyBills);
            }
            
            console.log('=== END DEBUG ===');
        }

        function readLocalBills() {
            try { return JSON.parse(localStorage.getItem('goixe_bills_v1') || '[]'); } catch { return []; }
        }

        function writeLocalBills(data) {
            localStorage.setItem('goixe_bills_v1', JSON.stringify(data));
        }

        function editBill(billNumber) {
            alert('Chức năng sửa Bill đang được phát triển');
        }

        function deleteBill(billNumber) {
            if (confirm('Bạn có chắc muốn xóa Bill này?')) {
                bills = bills.filter(b => b['Số Bill'] !== billNumber);
                renderAssignmentTable();
                alert('Đã xóa Bill thành công!');
            }
        }

        // Function to properly encode Vietnamese text for PDF
        function encodeVietnameseText(text) {
            if (!text) return '';
            // Keep Vietnamese characters with diacritics intact
            return String(text);
        }

        function printAssignments() {
            try {
                // Tạo một div ẩn để chứa bảng cho print
                const printDiv = document.createElement('div');
                printDiv.style.cssText = `
                    position: absolute;
                    left: -9999px;
                    top: -9999px;
                    width: 297mm;
                    background: white;
                    font-family: 'Segoe UI', 'Arial Unicode MS', 'Arial', 'Tahoma', sans-serif;
                    font-size: 12px;
                    line-height: 1.4;
                `;
                
                // Tạo header
                const header = document.createElement('div');
                header.style.cssText = 'text-align: center; margin-bottom: 20px;';
                header.innerHTML = `
                    <h1 style="font-size: 18px; margin: 0; color: #2c3e50;">BÁO CÁO ĐƠN HÀNG BILL</h1>
                    <p style="font-size: 12px; margin: 5px 0; color: #666;">Ngày xuất báo cáo: ${new Date().toLocaleDateString('vi-VN')}</p>
                `;
                printDiv.appendChild(header);
                
                // Tạo bảng
                const table = document.createElement('table');
                table.style.cssText = `
                    width: 100%;
                    border-collapse: collapse;
                    font-size: 6px;
                    margin-bottom: 20px;
                    table-layout: fixed;
                `;
                
                // Header của bảng với tất cả cột
                const thead = document.createElement('thead');
                thead.innerHTML = `
                    <tr style="background-color: #34495e; color: white;">
                        <th style="border: 1px solid #ddd; padding: 4px; text-align: center; font-size: 8px;">STT</th>
                        <th style="border: 1px solid #ddd; padding: 4px; text-align: center; font-size: 8px;">Số Bill</th>
                        <th style="border: 1px solid #ddd; padding: 4px; text-align: center; font-size: 8px;">Ngày bốc</th>
                        <th style="border: 1px solid #ddd; padding: 4px; text-align: center; font-size: 8px;">Mã khách gửi</th>
                        <th style="border: 1px solid #ddd; padding: 4px; text-align: center; font-size: 8px;">Tên khách gửi</th>
                        <th style="border: 1px solid #ddd; padding: 4px; text-align: center; font-size: 8px;">Xã</th>
                        <th style="border: 1px solid #ddd; padding: 4px; text-align: center; font-size: 8px;">Địa chỉ đã lưu</th>
                        <th style="border: 1px solid #ddd; padding: 4px; text-align: center; font-size: 8px;">Tên khách nhận</th>
                        <th style="border: 1px solid #ddd; padding: 4px; text-align: center; font-size: 8px;">Địa chỉ nhận</th>
                        <th style="border: 1px solid #ddd; padding: 4px; text-align: center; font-size: 8px;">Tỉnh nhận</th>
                        <th style="border: 1px solid #ddd; padding: 4px; text-align: center; font-size: 8px;">Xã nhận</th>
                        <th style="border: 1px solid #ddd; padding: 4px; text-align: center; font-size: 8px;">SĐT khách nhận</th>
                        <th style="border: 1px solid #ddd; padding: 4px; text-align: center; font-size: 8px;">Dịch vụ GTGT</th>
                        <th style="border: 1px solid #ddd; padding: 4px; text-align: center; font-size: 8px;">Nội dung hàng hóa</th>
                        <th style="border: 1px solid #ddd; padding: 4px; text-align: center; font-size: 8px;">Số kiện</th>
                        <th style="border: 1px solid #ddd; padding: 4px; text-align: center; font-size: 8px;">Trọng lượng thực</th>
                        <th style="border: 1px solid #ddd; padding: 4px; text-align: center; font-size: 8px;">Thể tích</th>
                        <th style="border: 1px solid #ddd; padding: 4px; text-align: center; font-size: 8px;">Đơn vị tính cước</th>
                        <th style="border: 1px solid #ddd; padding: 4px; text-align: center; font-size: 8px;">Đơn giá</th>
                        <th style="border: 1px solid #ddd; padding: 4px; text-align: center; font-size: 8px;">Phụ phí</th>
                        <th style="border: 1px solid #ddd; padding: 4px; text-align: center; font-size: 8px;">VAT</th>
                        <th style="border: 1px solid #ddd; padding: 4px; text-align: center; font-size: 8px;">Thành tiền</th>
                        <th style="border: 1px solid #ddd; padding: 4px; text-align: center; font-size: 8px;">Người thanh toán</th>
                        <th style="border: 1px solid #ddd; padding: 4px; text-align: center; font-size: 8px;">COD</th>
                        <th style="border: 1px solid #ddd; padding: 4px; text-align: center; font-size: 8px;">Trạng thái thanh toán</th>
                        <th style="border: 1px solid #ddd; padding: 4px; text-align: center; font-size: 8px;">Ghi chú</th>
                    </tr>
                `;
                table.appendChild(thead);
                
                // Body của bảng
                const tbody = document.createElement('tbody');
                
                // Sắp xếp bills theo STT
                const sortedBills = [...bills].sort((a, b) => {
                    const sttA = parseInt(a['STT']) || 0;
                    const sttB = parseInt(b['STT']) || 0;
                    return sttA - sttB;
                });
                
                sortedBills.forEach((bill, index) => {
                    const row = document.createElement('tr');
                    row.style.cssText = index % 2 === 0 ? 'background-color: #f8f9fa;' : 'background-color: white;';
                    row.innerHTML = `
                        <td style="border: 1px solid #ddd; padding: 3px; text-align: center; font-size: 7px;">${bill['STT'] || (index + 1)}</td>
                        <td style="border: 1px solid #ddd; padding: 3px; font-size: 7px;">${bill['Số Bill'] || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 3px; font-size: 7px;">${formatDate(bill['Ngày bốc']) || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 3px; font-size: 7px;">${bill['Mã khách gửi'] || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 3px; font-size: 7px;">${bill['Tên khách gửi'] || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 3px; font-size: 7px;">${bill['Xã'] || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 3px; font-size: 7px; word-wrap: break-word;">${bill['Địa chỉ đã lưu'] || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 3px; font-size: 7px;">${bill['Tên khách nhận'] || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 3px; font-size: 7px; word-wrap: break-word;">${bill['Địa chỉ nhận'] || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 3px; font-size: 7px;">${bill['Tỉnh nhận'] || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 3px; font-size: 7px;">${bill['Xã nhận'] || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 3px; font-size: 7px;">${bill['SĐT khách nhận'] || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 3px; font-size: 7px;">${bill['Dịch vụ GTGT'] || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 3px; font-size: 7px; word-wrap: break-word;">${bill['Nội dung hàng hóa'] || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 3px; text-align: center; font-size: 7px;">${bill['Số kiện'] || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 3px; text-align: center; font-size: 7px;">${bill['Trọng lượng thực'] || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 3px; text-align: center; font-size: 7px;">${bill['Thể tích'] || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 3px; font-size: 7px;">${bill['Đơn vị tính cước'] || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 3px; text-align: center; font-size: 7px;">${bill['Đơn giá'] || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 3px; text-align: center; font-size: 7px;">${bill['Phụ phí'] || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 3px; text-align: center; font-size: 7px;">${bill['VAT'] || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 3px; text-align: center; font-size: 7px;">${bill['Thành tiền'] || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 3px; font-size: 7px;">${bill['Người thanh toán'] || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 3px; text-align: center; font-size: 7px;">${bill['COD'] || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 3px; font-size: 7px;">${bill['Trạng thái thanh toán'] || ''}</td>
                        <td style="border: 1px solid #ddd; padding: 3px; font-size: 7px;">${bill['Ghi chú'] || ''}</td>
                    `;
                    tbody.appendChild(row);
                });
                
                table.appendChild(tbody);
                printDiv.appendChild(table);
                
                // Footer
                const footer = document.createElement('div');
                footer.style.cssText = 'text-align: center; margin-top: 20px; font-size: 12px;';
                footer.innerHTML = `<p><strong>Tổng số đơn hàng: ${bills.length}</strong></p>`;
                printDiv.appendChild(footer);
                
                // Thêm vào DOM
                document.body.appendChild(printDiv);
                
                // Mở dialog print
                window.print();
                
                // Xóa div tạm sau khi print
                setTimeout(() => {
                    if (document.body.contains(printDiv)) {
                        document.body.removeChild(printDiv);
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Error printing:', error);
                alert('Lỗi khi in: ' + error.message);
            }
        }

        function deleteAssignment(assignmentId) {
            if (confirm('Bạn có chắc muốn xóa phân phối này?')) {
                assignments = assignments.filter(a => a.ID !== assignmentId);
                renderAssignmentTable();
                loadUnassignedOrders();
                alert('Đã xóa phân phối thành công!');
            }
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const vehicleModal = document.getElementById('vehicleModal');
            const assignmentModal = document.getElementById('assignmentModal');
            
            if (event.target === vehicleModal) {
                closeVehicleModal();
            }
            if (event.target === assignmentModal) {
                closeAssignmentModal();
            }
        }
    </script>
</body>
</html>
